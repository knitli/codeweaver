{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Health Endpoint Contract",
  "description": "GET /health/ endpoint for CodeWeaver server status and metrics",
  "endpoint": {
    "path": "/health/",
    "method": "GET",
    "description": "Returns server health status, indexing progress, and service metrics"
  },
  "response_schema": {
    "type": "object",
    "properties": {
      "status": {
        "type": "string",
        "enum": [
          "healthy",
          "degraded",
          "unhealthy"
        ],
        "description": "Overall system health status"
      },
      "timestamp": {
        "type": "string",
        "format": "date-time",
        "description": "ISO8601 timestamp of health check"
      },
      "uptime_seconds": {
        "type": "integer",
        "minimum": 0,
        "description": "Server uptime in seconds"
      },
      "indexing": {
        "type": "object",
        "properties": {
          "state": {
            "type": "string",
            "enum": [
              "idle",
              "indexing",
              "error"
            ],
            "description": "Current indexing state"
          },
          "progress": {
            "type": "object",
            "properties": {
              "files_discovered": {
                "type": "integer",
                "minimum": 0,
                "description": "Total files discovered"
              },
              "files_processed": {
                "type": "integer",
                "minimum": 0,
                "description": "Files processed so far"
              },
              "chunks_created": {
                "type": "integer",
                "minimum": 0,
                "description": "Total chunks created"
              },
              "errors": {
                "type": "integer",
                "minimum": 0,
                "description": "Number of errors during indexing"
              },
              "current_file": {
                "type": "string",
                "description": "Currently processing file (if indexing)"
              },
              "start_time": {
                "type": "string",
                "format": "date-time",
                "description": "Indexing start timestamp"
              },
              "estimated_completion": {
                "type": "string",
                "format": "date-time",
                "description": "Estimated completion time"
              }
            },
            "required": [
              "files_discovered",
              "files_processed",
              "chunks_created",
              "errors"
            ]
          },
          "last_indexed": {
            "type": "string",
            "format": "date-time",
            "description": "Last successful indexing completion"
          }
        },
        "required": [
          "state",
          "progress"
        ]
      },
      "services": {
        "type": "object",
        "properties": {
          "vector_store": {
            "type": "object",
            "properties": {
              "status": {
                "type": "string",
                "enum": [
                  "up",
                  "down",
                  "degraded"
                ]
              },
              "latency_ms": {
                "type": "number",
                "minimum": 0
              }
            },
            "required": [
              "status",
              "latency_ms"
            ]
          },
          "embedding_provider": {
            "type": "object",
            "properties": {
              "status": {
                "type": "string",
                "enum": [
                  "up",
                  "down"
                ]
              },
              "model": {
                "type": "string"
              },
              "latency_ms": {
                "type": "number",
                "minimum": 0
              },
              "circuit_breaker_state": {
                "type": "string",
                "enum": [
                  "closed",
                  "open",
                  "half_open"
                ]
              }
            },
            "required": [
              "status",
              "model",
              "latency_ms",
              "circuit_breaker_state"
            ]
          },
          "sparse_embedding": {
            "type": "object",
            "properties": {
              "status": {
                "type": "string",
                "enum": [
                  "up",
                  "down"
                ]
              },
              "provider": {
                "type": "string"
              }
            },
            "required": [
              "status",
              "provider"
            ]
          },
          "reranking": {
            "type": "object",
            "properties": {
              "status": {
                "type": "string",
                "enum": [
                  "up",
                  "down"
                ]
              },
              "model": {
                "type": "string"
              },
              "latency_ms": {
                "type": "number",
                "minimum": 0
              }
            },
            "required": [
              "status",
              "model",
              "latency_ms"
            ]
          }
        },
        "required": [
          "vector_store",
          "embedding_provider",
          "sparse_embedding",
          "reranking"
        ]
      },
      "statistics": {
        "type": "object",
        "properties": {
          "total_chunks_indexed": {
            "type": "integer",
            "minimum": 0
          },
          "total_files_indexed": {
            "type": "integer",
            "minimum": 0
          },
          "languages_indexed": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "index_size_mb": {
            "type": "integer",
            "minimum": 0
          },
          "queries_processed": {
            "type": "integer",
            "minimum": 0
          },
          "avg_query_latency_ms": {
            "type": "number",
            "minimum": 0
          }
        },
        "required": [
          "total_chunks_indexed",
          "total_files_indexed",
          "languages_indexed",
          "index_size_mb",
          "queries_processed",
          "avg_query_latency_ms"
        ]
      }
    },
    "required": [
      "status",
      "timestamp",
      "uptime_seconds",
      "indexing",
      "services",
      "statistics"
    ]
  },
  "status_determination_rules": {
    "healthy": {
      "description": "All services up, indexing idle or progressing normally",
      "conditions": [
        "vector_store.status == 'up'",
        "embedding_provider.status == 'up' OR sparse_embedding.status == 'up'",
        "indexing.state == 'idle' OR indexing.state == 'indexing' AND indexing.progress.errors < 25"
      ]
    },
    "degraded": {
      "description": "Some services down but core functionality works (e.g., sparse-only search)",
      "conditions": [
        "vector_store.status == 'up'",
        "embedding_provider.status == 'down' AND sparse_embedding.status == 'up'",
        "OR indexing.progress.errors >= 25"
      ]
    },
    "unhealthy": {
      "description": "Critical services down (vector store unavailable)",
      "conditions": [
        "vector_store.status == 'down'",
        "OR indexing.state == 'error'"
      ]
    }
  },
  "examples": [
    {
      "description": "Healthy system, indexing in progress",
      "response": {
        "status": "healthy",
        "timestamp": "2025-10-27T14:30:00Z",
        "uptime_seconds": 3600,
        "indexing": {
          "state": "indexing",
          "progress": {
            "files_discovered": 1247,
            "files_processed": 450,
            "chunks_created": 3250,
            "errors": 2,
            "current_file": "src/services/search.py",
            "start_time": "2025-10-27T14:00:00Z",
            "estimated_completion": "2025-10-27T15:00:00Z"
          },
          "last_indexed": "2025-10-26T10:00:00Z"
        },
        "services": {
          "vector_store": {
            "status": "up",
            "latency_ms": 12
          },
          "embedding_provider": {
            "status": "up",
            "model": "voyage-code-3",
            "latency_ms": 185,
            "circuit_breaker_state": "closed"
          },
          "sparse_embedding": {
            "status": "up",
            "provider": "fastembed_local"
          },
          "reranking": {
            "status": "up",
            "model": "voyage-rerank-2.5",
            "latency_ms": 150
          }
        },
        "statistics": {
          "total_chunks_indexed": 3250,
          "total_files_indexed": 450,
          "languages_indexed": [
            "python",
            "typescript",
            "rust"
          ],
          "index_size_mb": 45,
          "queries_processed": 127,
          "avg_query_latency_ms": 850
        }
      }
    },
    {
      "description": "Degraded system, embedding API down, using sparse-only search",
      "response": {
        "status": "degraded",
        "timestamp": "2025-10-27T15:00:00Z",
        "uptime_seconds": 7200,
        "indexing": {
          "state": "idle",
          "progress": {
            "files_discovered": 1247,
            "files_processed": 1247,
            "chunks_created": 8500,
            "errors": 15
          },
          "last_indexed": "2025-10-27T14:45:00Z"
        },
        "services": {
          "vector_store": {
            "status": "up",
            "latency_ms": 15
          },
          "embedding_provider": {
            "status": "down",
            "model": "voyage-code-3",
            "latency_ms": 0,
            "circuit_breaker_state": "open"
          },
          "sparse_embedding": {
            "status": "up",
            "provider": "fastembed_local"
          },
          "reranking": {
            "status": "down",
            "model": "voyage-rerank-2.5",
            "latency_ms": 0
          }
        },
        "statistics": {
          "total_chunks_indexed": 8500,
          "total_files_indexed": 1247,
          "languages_indexed": [
            "python",
            "typescript",
            "rust",
            "go"
          ],
          "index_size_mb": 120,
          "queries_processed": 450,
          "avg_query_latency_ms": 450
        }
      }
    },
    {
      "description": "Unhealthy system, vector store unavailable",
      "response": {
        "status": "unhealthy",
        "timestamp": "2025-10-27T16:00:00Z",
        "uptime_seconds": 10800,
        "indexing": {
          "state": "error",
          "progress": {
            "files_discovered": 1247,
            "files_processed": 200,
            "chunks_created": 1500,
            "errors": 50
          },
          "last_indexed": "2025-10-27T14:45:00Z"
        },
        "services": {
          "vector_store": {
            "status": "down",
            "latency_ms": 0
          },
          "embedding_provider": {
            "status": "up",
            "model": "voyage-code-3",
            "latency_ms": 185,
            "circuit_breaker_state": "closed"
          },
          "sparse_embedding": {
            "status": "up",
            "provider": "fastembed_local"
          },
          "reranking": {
            "status": "up",
            "model": "voyage-rerank-2.5",
            "latency_ms": 150
          }
        },
        "statistics": {
          "total_chunks_indexed": 8500,
          "total_files_indexed": 1247,
          "languages_indexed": [
            "python",
            "typescript",
            "rust",
            "go"
          ],
          "index_size_mb": 120,
          "queries_processed": 450,
          "avg_query_latency_ms": 0
        }
      }
    }
  ],
  "performance_requirements": {
    "response_time": {
      "p95": "<200ms",
      "description": "Health endpoint must respond within 200ms for p95"
    },
    "update_frequency": {
      "indexing_progress": "Every 5 seconds during indexing",
      "service_health": "Real-time on request"
    }
  }
}