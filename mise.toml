# SPDX-FileCopyrightText: 2025 Knitli Inc.
# SPDX-FileContributor: Adam Poulemanos <adam@knit.li>
#
# SPDX-License-Identifier: MIT OR Apache-2.0
experimental_monorepo_root = true

[env]
MISE_EXPERIMENTAL = "1"
GH_REPO = "knitli/codeweaver"
REMOTE_ORIGIN_URL = '''http://github.com/knitli/codeweaver.git'''
PROJECT_NAME = "codeweaver"
# According to the mise docs, config_root should always be the project root. Even if the mise.toml is in a subdirectory.
# But that didn't seem to be the case, so we manually trim known suffixes.
CODEWEAVER_PROJECT_PATH = '''{{ config_root | trim | trim_end_matches(pat="/") | trim_end_matches(pat="/mise") | trim_end_matches(pat="/.config") }}'''
# Get version from git tags (uv-dynamic-versioning uses git as source)
# Falls back to "dev" if git command fails
CODEWEAVER_VERSION = '''{{ exec(command='git describe --tags --always --dirty 2>/dev/null || echo "dev"') | trim }}'''
CI = '''{% if get_env(name="GITHUB_ACTIONS", default="") != "" %}true{% else %}false{% endif %}'''
_.path = [
  "bin",
  "scripts/dev-env",
  "scripts/code-quality",
  "scripts/build",
  "scripts/language-support",
  "scripts/testing",
  "scripts/utils",
  ".venv/bin",
]
MISE_PYTHON = '''{% if get_env(name="UV_PYTHON", default="") != "" %}{{ get_env(name="UV_PYTHON") }}{% else %}{{ get_env(name="PYTHON_VERSION", default="3.13") }}{% endif %}'''
MISE_ENV = '''{% if get_env(name="CI", default="") == "true" %}""{% else %}dev{% endif %}'''

[settings]
idiomatic_version_file_enable_tools = []
experimental = true

[settings.python]
compile = true
uv_venv_create_args = [
  "--seed",
  "--keyring-provider",
  "subprocess",
  "--python",
  "{{ get_env(name='MISE_PYTHON', default='') }}",
]

[tools]
# most tools are defined in mise.dev.toml to keep CI workflows lightweight
python = '''{{ get_env(name="MISE_PYTHON", default="") }}'''

[tasks.info]
description = "Print project information"
run = '''
echo "Project: $PROJECT_NAME"
echo "Virtual Environment: $VIRTUAL_ENV"
'''
run_windows = '''
echo Project: %PROJECT_NAME%
echo Virtual Environment: %VIRTUAL_ENV%
'''

[tasks.sync]
depends = ["source"]
tools.uv = "latest"
run = '''
echo "Syncing dependencies..."
uv sync --extra full --group dev --group docs --group build --group test
'''
run_windows = '''
echo Syncing dependencies...
uv sync --extra full --group dev --group docs --group build --group test
'''

[tasks.source]
run = '''
#!/usr/bin/env zsh
# Source the virtual environment
print -P "%F{209}[codeweaver]%f Sourcing virtual environment..."
git rev-parse --show-toplevel || true
source .venv/bin/activate
'''
run_windows = '''
echo [codeweaver] Sourcing virtual environment...
git rev-parse --show-toplevel
.venv\Scripts\activate.bat
'''

[tasks.setup]
# Development setup
shell = "zsh -c"
run = [
  "print -P \"%F{209}[codeweaver]%f Setting up development environment for the first time...\"",
  "mise set &>/dev/null",
  "mise -y trust &>/dev/null",
  "mise -y install &>/dev/null || true",
  "mise -y //:venv &>/dev/null",
  "mise -y //:sync &>/dev/null",
  "mise env &>/dev/null || true",
  "git config include.path .gitconfig &>/dev/null || true",
  "echo 'src/codeweaver/_version.py' >> .git/info/exclude",
  "echo 'coverage.xml' >> .git/info/exclude",
  "ln -sf AGENTS.md CLAUDE.md",
  "eval \"$(mise activate zsh)\" &>/dev/null",
]
run_windows = [
  "echo [codeweaver] Setting up development environment for the first time...",
  "mise set > NUL 2>&1",
  "mise -y trust > NUL 2>&1",
  "mise -y install > NUL 2>&1 || echo.",
  "mise -y //:venv > NUL 2>&1",
  "mise -y //:sync > NUL 2>&1",
  "mise env > NUL 2>&1",
  "git config include.path .gitconfig > NUL 2>&1",
  "echo src/codeweaver/_version.py >> .git\\info\\exclude",
  "echo coverage.xml >> .git\\info\\exclude",
  "mklink CLAUDE.md AGENTS.md > NUL 2>&1",
  "mise activate cmd",
]
silent = "stdout"

[tasks.setup.env]
MISE_EXPERIMENTAL = "1"
MISE_ENV = "dev"

[tasks.setup.tools]
uv = "latest"

[tasks.fix-python]
tools.uv = "latest"
tools.ast-grep = "latest"
usage = '''
arg "[dir]" help="directories to fix" var=#true default="."
'''
run = [
  "uvx ruff format \"${usage_dir}\"",
  "uvx ruff check --fix --unsafe-fixes \"${usage_dir}\"",
]
run_windows = [
  "uvx ruff format .",
  "uvx ruff check --fix --unsafe-fixes .",
]
file = "scripts/code-quality/fix-ruff-patterns.sh"
sources = ["{src,scripts,tests}/*.py"]

[tasks.check]
tools.hk = "latest"
tools.pkl = "latest"
run = '''
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Running quality checks..."
hk check
'''
run_windows = '''
echo [codeweaver] Running quality checks...
hk check
'''

[tasks.lint]
tools.uv = "latest"
run = '''
#!/bin/bash
echo "Running linting checks..."
if [[ "$CI" == "true" ]]; then
    uv run ruff check . --output-format=github
else
    uv run ruff check .
fi
'''
run_windows = '''
echo Running linting checks...
if "%CI%"=="true" (
    uv run ruff check . --output-format=github
) else (
    uv run ruff check .
)
'''

[tasks.format]
run = '''
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Running formatting checks..."
hk fix
'''
run_windows = '''
echo [codeweaver] Running formatting checks...
hk fix
'''

[tasks.format.tools]
"cargo:typos" = "latest"
"pipx:reuse" = "latest"
"pipx:tombi" = "latest"
"pipx:ty" = "latest"
actionlint = "latest"
hk = "latest"
pkl = "latest"
shellcheck = "latest"
shfmt = "latest"
yq = "latest"

[tasks.format-fix]
run = '''
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Applying formatting...hold onto your butts ðŸš¬...ðŸ¦– "
# mise -y //:fix-ruff-patterns || {  # there are some bugs to work out
#    print -P "%F{209}[codeweaver]%f âš ï¸  %F{red}Ruff pattern fixer encountered issues.%f"}
uv run ruff format .
files="$(git ls-files "*.yaml" "*.yml" "*.json" 2>/dev/null)"
if [ -n "$files" ]; then
    echo "$files" | rust-parallel -d stderr -i - --no-run-if-empty yq -iP --indent=2 "." || true
fi
files="$(git ls-files "*.toml" 2>/dev/null)"
if [ -n "$files" ]; then
    tombi format $files 2>/dev/null || true
fi
'''
run_windows = '''
echo [codeweaver] Applying formatting...hold onto your butts ðŸš¬...ðŸ¦–
uv run ruff format .
for /f "delims=" %%f in ('git ls-files "*.yaml" "*.yml" "*.json" 2^>NUL') do (
    yq -iP --indent=2 "." "%%f" 2>NUL
)
for /f "delims=" %%f in ('git ls-files "*.toml" 2^>NUL') do (
    tombi format "%%f" 2>NUL
)
'''

[tasks.format-fix.tools]
"cargo:rust-parallel" = "latest"
"pipx:tombi" = "latest"
"yq" = "latest"
uv = "latest"

[tasks.graph]
usage = '''
arg "[dir]" help="python directory to generate a graph for" default="src"
'''
run = '''mise x -- ruff analyze graph --target-version py312 --python .venv/bin/python "${usage_dir:-src/}"'''
run_windows = '''mise x -- ruff analyze graph --target-version py312 --python .venv\Scripts\python.exe .'''

[tasks.tree]
tools.uv = "latest"
run = '''uv tree --no-dev --group full'''

[tasks.venv]
env.MISE_EXPERIMENTAL = "1"
tools.uv = "latest"
shell = "zsh -c"
run = '''
print -P "%F{209}[codeweaver]%f Setting up Python virtual environment..."
uv venv --allow-existing --seed --keyring-provider subprocess --python 3.13 --refresh .venv &&
print -P "%F{209}[codeweaver]%f âœ… Virtual environment is ready!"
source .venv/bin/activate || print -P "%F{209}[codeweaver]%f âš ï¸  %F{red}Failed to source virtual environment.%f"
print -P "%F{209}[codeweaver]%f Running dependency sync..."
mise //:sync &
'''
run_windows = '''
echo [codeweaver] Setting up Python virtual environment...
uv venv --allow-existing --seed --keyring-provider subprocess --python 3.13 --refresh .venv
if %ERRORLEVEL% equ 0 (
    echo [codeweaver] Virtual environment is ready!
    call .venv\Scripts\activate.bat
    if %ERRORLEVEL% neq 0 (
        echo [codeweaver] WARNING: Failed to source virtual environment.
    )
)
echo [codeweaver] Running dependency sync...
start /b mise //:sync
'''

[tasks.test]
# Testing
tools.uv = "latest"
tools."pipx:pytest" = "9.0.1"
usage = '''
args "[dir]" help="directory to test" default="tests/"
flag "--marks [markers]" help="pytest markers to filter tests" default=""
'''
run = '''
#!/bin/bash
echo "Running tests..."
uv run pytest
'''
run_windows = '''
echo Running tests...
uv run pytest
'''

[tasks.test-cov]
tools.uv = "latest"
run = '''
#!/bin/bash
echo "Running tests with coverage..."
uv sync --group test --inexact
uv run pytest tests/ --cov=codeweaver --cov-report=xml --cov-report=term-missing --junit-xml=test-results.xml -v "$@"
'''
run_windows = '''
echo Running tests with coverage...
uv sync --group test --inexact
uv run pytest tests/ --cov=codeweaver --cov-report=xml --cov-report=term-missing --junit-xml=test-results.xml -v %*
'''

[tasks.clean]
run = '''
#!/bin/bash
echo "Cleaning build artifacts..."
rm -rf dist/ build/ *.egg-info/ .coverage test-results.xml &&
find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true &&
find . -type f -name "*.pyc" -delete &&
echo "âœ… Build artifacts cleaned!"
'''
run_windows = '''
echo Cleaning build artifacts...
if exist dist rd /s /q dist
if exist build rd /s /q build
if exist *.egg-info rd /s /q *.egg-info
if exist .coverage del .coverage
if exist test-results.xml del test-results.xml
for /d /r . %%d in (__pycache__) do @if exist "%%d" rd /s /q "%%d"
del /s /q *.pyc 2>NUL
echo Build artifacts cleaned!
'''

# Release and maintenance
[tasks.version]
tools.uv = "latest"
run = '''
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver] CodeWeaver%f version information:"
print -P "%F{209}[codeweaver]%f ðŸ“¦ Package version: $(uv run python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")"
print -P "%F{209}[codeweaver]%f ðŸ Python version: $(python --version)"
print -P "%F{209}[codeweaver]%f ðŸŒž UV version: $(uv --version)"
'''
run_windows = '''
echo [codeweaver] CodeWeaver version information:
for /f "delims=" %%v in ('uv run python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])"') do echo [codeweaver] Package version: %%v
for /f "delims=" %%v in ('python --version') do echo [codeweaver] Python version: %%v
for /f "delims=" %%v in ('uv --version') do echo [codeweaver] UV version: %%v
'''

[tasks.pre-commit]
shell = "zsh -c"
env.MISE_EXPERIMENTAL = "1"
run = [
  "print -P \"%F{209}[codeweaver]%f Running %F{209}CodeWeaver%f pre-commit checks ðŸª... %F{38} Thanks for your contributions! You're pretty cool.%f ðŸš€\" || true",
  "mise //:format || print -P \"%F{209}[codeweaver]%f âš ï¸  %F{red}You need to fix some issues%f before committing. %F{209}Do not pass go, do not collect 200 dollars.%f ðŸ’¸ ðŸ˜¦\" && exit 1",
  "git add .",
  "git commit --amend --no-edit || true",
  "mise //:check || print -P \"%F{209}[codeweaver]%f âš ï¸  %F{red}You need to fix some issues before committing. Almost there!%f\" && exit 1",
  "print -P \"%F{209}[codeweaver]%f âœ… %F{green}All pre-commit checks passed! You're awesome!%f ðŸŽ‰ ... and they said the Kobiyashi Maru was unwinnable! ðŸ––\"",
]
run_windows = '''
echo [codeweaver] Running CodeWeaver pre-commit checks... Thanks for your contributions! You're pretty cool. ðŸš€
mise //:format
if %ERRORLEVEL% neq 0 (
    echo [codeweaver] WARNING: You need to fix some issues before committing.
    exit /b 1
)
git add .
git commit --amend --no-edit || echo.
mise //:check
if %ERRORLEVEL% neq 0 (
    echo [codeweaver] WARNING: You need to fix some issues before committing. Almost there!
    exit /b 1
)
echo [codeweaver] All pre-commit checks passed! You're awesome!
'''

[tasks.activate]
run = '''eval "$(mise activate zsh)" &>/dev/null'''
run_windows = '''mise activate cmd'''
hide = true
