# SPDX-FileCopyrightText: 2025 Knitli Inc.
# SPDX-FileContributor: Adam Poulemanos <adam@knit.li>
#
# SPDX-License-Identifier: MIT OR Apache-2.0
experimental_monorepo_root = true

[env]
MISE_EXPERIMENTAL = "1"
GH_REPO = "knitli/codeweaver"
REMOTE_ORIGIN_URL = '''http://github.com/knitli/codeweaver.git'''
PROJECT_NAME = "codeweaver"
# According to the mise docs, config_root should always be the project root. Even if the mise.toml is in a subdirectory.
# But that didn't seem to be the case, so we manually trim known suffixes.
CODEWEAVER_PROJECT_PATH = '''{{ config_root | trim | trim_end_matches(pat="/") | trim_end_matches(pat="/mise") | trim_end_matches(pat="/.config") }}'''
# Get version from git tags (uv-dynamic-versioning uses git as source)
# Falls back to "dev" if git command fails
CODEWEAVER_VERSION = '''{{ exec(command='git describe --tags --always --dirty 2>/dev/null || echo "dev"') | trim }}'''
CI = '''{% if get_env(name="GITHUB_ACTIONS", default="") != "" %}true{% else %}false{% endif %}'''
_.path = [
    "bin",
    "scripts/dev-env",
    "scripts/code-quality",
    "scripts/build",
    "scripts/language-support",
    "scripts/testing",
    "scripts/utils",
    ".venv/bin",
]
MISE_ENV = '''{% if get_env(name="CI", default="") == "true" %}""{% else %}dev{% endif %}'''
CW_PREFIX = '''{% if get_env(name="CI", default="") == "true" %}[codeweaver]{% elif get_env(name="TERM", default="xterm-256color") == "*truecolor*" %}\033[38;2;181;108;48;m[codeweaver]\033[0m{% else %}\033[38;5;131m[codeweaver]\033[0m{% endif %}'''
# this is a bit redundant but it makes it easier to override in CI environments
MISE_PYTHON_VERSION = '''{{ get_env(name="MISE_PYTHON_VERSION", default="3.13") }}'''
HK_MISE = "1"

[settings]
idiomatic_version_file_enable_tools = []
experimental = true

[settings.python]

[tools]
# most tools are defined in mise.dev.toml to keep CI workflows lightweight
# Where needed, tools are defined at the task level here, which allows for more granular control
python = '''{{ get_env(name="MISE_PYTHON_VERSION", default="3.13") }}'''
uv = "latest"

# Quick note for those unfamiliar with mise:
#   - despite the namespace, tools prefixed with "pipx:" are installed via "uv" (I assume once upon a time they were installed with pipx before uv came along)
#   - some tools have no prefix -- these are defined in mise's internal registry directly
#   - The prefix refers to the "backend" used to install the tool -- most of the no-prefix tools are installed through `aqua` or github/gitlab releases, and failing that, `ubi`. Language-specific package managers (cargo/npm/go) are also used where appropriate.

[tasks.info]
description = "Print project information"
run = '''
echo "${CW_PREFIX} Project: $PROJECT_NAME"
echo "${CW_PREFIX} Virtual Environment: $VIRTUAL_ENV"

echo "${CW_PREFIX} Python Version: $(python --version 2>&1)"
echo "${CW_PREFIX} CodeWeaver Version: $CODEWEAVER_VERSION"
echo "${CW_PREFIX} Project Path: $CODEWEAVER_PROJECT_PATH"
'''
run_windows = '''
echo [codeweaver] Project: %PROJECT_NAME%
echo [codeweaver] Virtual Environment: %VIRTUAL_ENV%
echo [codeweaver] Python Version: %PYTHON_VERSION%
echo [codeweaver] CodeWeaver Version: %CODEWEAVER_VERSION%
echo [codeweaver] Project Path: %CODEWEAVER_PROJECT_PATH%
'''

[tasks.sync]
depends = ["source"]
tools.uv = "latest"
run = '''
echo "${CW_PREFIX} Syncing dependencies..."
uv sync --extra full --group dev --group docs --group build --group test --no-install-workspace
'''
run_windows = '''
echo [codeweaver] Syncing dependencies...
uv sync --extra full --group dev --group docs --group build --group test --no-install-workspace
'''

[tasks.source]
run = '''
# Source the virtual environment
echo "${CW_PREFIX} Sourcing virtual environment..."
git rev-parse --show-toplevel || true
if [ ! -d ".venv" ]; then
    echo "${CW_PREFIX} ‚ö†Ô∏è  \033[0;31mVirtual environment not found. We'll try to proceed, but things may break!\033[0m"
    uv venv --seed --keyring-provider subprocess --python {{ get_env(name='MISE_PYTHON_VERSION', default='3.13') }} .venv
fi
. .venv/bin/activate || echo "${CW_PREFIX} ‚ö†Ô∏è  \033[0;31mFailed to source virtual environment.\033[0m"
'''
run_windows = '''
echo [codeweaver] Sourcing virtual environment...
git rev-parse --show-toplevel
.venv\Scripts\activate.bat
'''

[tasks.setup]
# Development setup
run = [
    "echo \"${CW_PREFIX} Setting up development environment for the first time...\"",
    "mise set &>/dev/null",
    "mise trust --all &>/dev/null",
    "mise install &>/dev/null || echo \"${CW_PREFIX} ‚ö†Ô∏è  WARNING: mise install failed during setup.\"",
    "mise //:venv &>/dev/null",
    "git config include.path .gitconfig &>/dev/null || true",
    "echo 'src/codeweaver/_version.py' >> .git/info/exclude",
    "echo 'coverage.xml' >> .git/info/exclude",
    "echo 'test-results.xml' >> .git/info/exclude",
    "ln -sf AGENTS.md CLAUDE.md",
    "eval \"$(mise activate \"$ACTIVE_SHELL\")\" &>/dev/null",
]
run_windows = [
    "echo [codeweaver] Setting up development environment for the first time...",
    "mise set > NUL 2>&1",
    "mise trust --all > NUL 2>&1",
    "mise install > NUL 2>&1 || echo \"[codeweaver] WARNING: mise install failed during setup.\"",
    "mise //:venv > NUL 2>&1",
    "git config include.path .gitconfig > NUL 2>&1",
    "echo src/codeweaver/_version.py >> .git\\info\\exclude",
    "echo coverage.xml >> .git\\info\\exclude",
    "echo test-results.xml >> .git\\info\\exclude",
    "mklink CLAUDE.md AGENTS.md > NUL 2>&1",
    "mise activate cmd",
]
silent = "stdout"

[tasks.setup.env]
MISE_EXPERIMENTAL = "1"
MISE_ENV = "dev"
MISE_YES = "1"
ACTIVE_SHELL = '''{{ exec(command='basename "$SHELL" 2>/dev/null || echo zsh') }}'''

[tasks.setup.tools]
uv = "latest"

[tasks.cloud-setup]
run = [
    "echo \"[codeweaver] Setting up cloud development environment...\"",
    "ln -sf AGENTS.md CLAUDE.md",
    '''if ! command -v mise &>/dev/null; then
      if [ -d "$HOME/.local/share/mise" ] || [ -d "$HOME/.mise" ] || [ -f "$HOME/.local/bin/mise" ]; then
        export PATH="$HOME/.local/bin:$HOME/.mise/bin:$HOME/.local/share/mise/bin:$PATH"
        if ! grep -q "mise activate" "$HOME/.bashrc"; then
          echo "eval \"$(mise activate \"${ACTIVE_SHELL:-bash}\")\" 2>&1 || true" >> "$HOME/.bashrc"
        fi
      else
        chmod +x scripts/dev-env/install-mise.sh 2>&1 || true
        ./scripts/dev-env/install-mise.sh 2>&1 || true
      fi
  fi''',
    "mise -y trust --all 2>&1 || true",
    "mise install 2>&1 || true",
    "hk install --mise 2>&1 || mise x hk@latest -- hk install --mise 2>&1 || true",
    "mise x uv@latest -- uv venv --allow-existing --seed --keyring-provider subprocess --python {{ get_env(name='MISE_PYTHON', default='3.13') }} .venv 2>&1",
    "source .venv/bin/activate 2>&1 || true",
    "mise x uv@latest -- uv sync --group dev --group test 2>&1",
    "git config include.path .gitconfig 2>&1 || true",
    '''
  ignore_files=('src/codeweaver/_version.py' 'coverage.xml' 'test-results.xml')
  for file in "${ignore_files[@]}"; do
    if ! grep -qx "$file" .git/info/exclude; then
      echo "$file" >> .git/info/exclude 2>&1
    fi
  done
  ''',
    "echo \"[codeweaver] Cloud development environment setup complete!\"",
]

[tasks.cloud-setup.env]
ACTIVE_SHELL = '''{{ exec(command='basename "$SHELL" 2>/dev/null || echo bash') }}'''
MISE_EXPERIMENTAL = "1"
MISE_ENV = "dev"
MISE_YES = "1"

[tasks.fix-python]
tools.uv = "latest"
tools.ast-grep = "latest"
usage = '''
arg "[dir]" help="directory to fix (default: current directory)" default="."
'''
run = [
    "uvx ruff format \"${usage_dir}\"",
    "uvx ruff check --fix --unsafe-fixes \"${usage_dir}\"",
]
run_windows = ["uvx ruff format .", "uvx ruff check --fix --unsafe-fixes ."]
file = "scripts/code-quality/fix-ruff-patterns.sh"
sources = ["{src,scripts,tests,mise-tasks}/*.py"]

[tasks.check]
tools.hk = "latest"
tools.pkl = "latest"
tools."pipx:ty" = "latest"
tools."pipx:reuse" = "latest"
tools.ruff = "latest"
run = '''
echo "${CW_PREFIX} Running quality checks..."
hk check
'''
run_windows = '''
echo [codeweaver] Running quality checks...
hk check
'''

[tasks.lint]
tools.uv = "latest"
usage = '''
arg "[dir]" help="directory to lint" default="."
flag "-f --format <format>" {
  help "Output format"
  choices "text" "json" "junit" "github" "gitlab" "pylint" "grouped"
  default "text"
}
flag "--fix" help="Apply auto-fixes"
'''
run = '''
echo "${CW_PREFIX} Running linting checks..."

# Determine output format (CI overrides)
OUTPUT_FORMAT="${usage_format}"
if [ "$CI" = "true" ] && [ "${usage_format}" = "text" ]; then
    OUTPUT_FORMAT="github"
fi

# Build ruff command
RUFF_CMD="uv run ruff check \"${usage_dir}\" --output-format=${OUTPUT_FORMAT}"
if [ "${usage_fix}" = "true" ]; then
    RUFF_CMD="$RUFF_CMD --fix"
fi

eval "$RUFF_CMD"
'''
run_windows = '''
echo [codeweaver] Running linting checks...

set OUTPUT_FORMAT=%usage_format%
if "%CI%"=="true" if "%usage_format%"=="text" set OUTPUT_FORMAT=github

if "%usage_fix%"=="true" (
    uv run ruff check "%usage_dir%" --output-format=%OUTPUT_FORMAT% --fix
) else (
    uv run ruff check "%usage_dir%" --output-format=%OUTPUT_FORMAT%
)
'''

[tasks.format]
run = '''
echo "${CW_PREFIX} Running formatting checks..."
hk fix
'''
run_windows = '''
echo [codeweaver] Running formatting checks...
hk fix
'''

[tasks.format.tools]
"aqua:typos" = "latest"
"pipx:reuse" = "latest"
"aqua:tombi-toml/tombi" = "latest"
"ubi:astral-sh/ty" = "latest"
actionlint = "latest"
hk = "latest"
pkl = "latest"
shellcheck = "latest"
shfmt = "latest"
yq = "latest"

[tasks.format-fix]
run = '''
echo "${CW_PREFIX} Applying formatting...hold onto your butts üö¨...ü¶ñ "
# mise -y //:fix-ruff-patterns || {  # there are some bugs to work out
#    echo "${CW_PREFIX} ‚ö†Ô∏è  \033[0;32mRuff pattern fixer encountered issues.\033[0m"}
uv run ruff format .
git ls-files "*.yaml" "*.yml" "*.json" 2>/dev/null | xargs -r yq -iP --indent=2 eval "." 2>/dev/null || true
toml_files="$(git ls-files "*.toml" 2>/dev/null)"
if [ -n "$toml_files" ]; then
    printf '%s\n' "$toml_files" | xargs -r tombi format 2>/dev/null || true
fi
'''
run_windows = '''
echo [codeweaver] Applying formatting...hold onto your butts üö¨...ü¶ñ
uv run ruff format .
for /f "delims=" %%f in ('git ls-files "*.yaml" "*.yml" "*.json" 2^>NUL') do (
    yq -iP --indent=2 "." "%%f" 2>NUL
)
for /f "delims=" %%f in ('git ls-files "*.toml" 2^>NUL') do (
    tombi format "%%f" 2>NUL
)
'''

[tasks.format-fix.tools]
"aqua:tombi-toml/tombi" = "latest"
yq = "latest"
uv = "latest"

[tasks.graph]
usage = '''
arg "[dir]" help="python directory to generate a graph for" default="src"
'''
run = '''mise x -- ruff analyze graph --target-version py312 --python .venv/bin/python "${usage_dir:-src/}"'''
run_windows = '''mise x -- ruff analyze graph --target-version py312 --python .venv\Scripts\python.exe .'''

[tasks.tree]
tools.uv = "latest"
run = '''uv tree --no-dev --group full'''

[tasks.venv]
env.MISE_EXPERIMENTAL = "1"
tools.uv = "latest"
run = '''
echo "${CW_PREFIX} Setting up Python virtual environment..."
uv venv --allow-existing --seed --keyring-provider subprocess --python {{ get_env(name="MISE_PYTHON_VERSION", default="3.13") }} --refresh .venv &&
echo "${CW_PREFIX} ‚úÖ Virtual environment is ready!"
. .venv/bin/activate || echo "${CW_PREFIX} ‚ö†Ô∏è  \033[0;31mFailed to source virtual environment.\033[0m"
echo "${CW_PREFIX} Running dependency sync..."
mise //:sync &
'''
run_windows = '''
echo [codeweaver] Setting up Python virtual environment...
uv venv --allow-existing --seed --keyring-provider subprocess --python {{ get_env(name="MISE_PYTHON_VERSION", default="3.13") }} --refresh .venv
if %ERRORLEVEL% equ 0 (
    echo [codeweaver] Virtual environment is ready!
    call .venv\Scripts\activate.bat
    if %ERRORLEVEL% neq 0 (
        echo [codeweaver] WARNING: Failed to source virtual environment.
    )
)
echo [codeweaver] Running dependency sync...
start /b mise //:sync
'''

[tasks.test]
# Testing with flexible profiles and marker selection
tools.python = '''{{ get_env(name="MISE_PYTHON_VERSION", default="3.13") }}'''
tools.uv = "latest"
usage = '''
arg "[dir]" help="directory to test" default="tests/"
flag "-m --marks <markers>" help="pytest markers to filter tests"
flag "-p --profile <profile>" {
  help "Test profile preset"
  choices "fast" "integration" "real" "heavy" "all" "skip-list"
}
flag "--cov" help="Run with coverage reporting"
'''
run = '''
echo "${CW_PREFIX} Running tests..."

# Set markers based on profile
PYTEST_MARKS="${usage_marks}"
case "${usage_profile}" in
  fast)
    PYTEST_MARKS="unit and not expensive and not requires_models"
    echo "${CW_PREFIX} Running fast unit tests (CI subset)..."
    ;;
  integration)
    PYTEST_MARKS="integration and not real_providers and not expensive"
    echo "${CW_PREFIX} Running integration tests..."
    ;;
  real)
    PYTEST_MARKS="real_providers"
    echo "${CW_PREFIX} Running real provider tests (requires model downloads)..."
    ;;
  heavy)
    PYTEST_MARKS="requires_models or expensive"
    echo "${CW_PREFIX} Running heavy tests (requires models)..."
    ;;
  skip-list)
    echo "${CW_PREFIX} Listing skipped tests..."
    uv run pytest --collect-only -m "skip" "$@"
    exit 0
    ;;
  all)
    echo "${CW_PREFIX} Running ALL tests (including expensive ones)..."
    ;;
esac

# Build pytest command
PYTEST_CMD="uv run pytest \"${usage_dir}\""
if [ -n "$PYTEST_MARKS" ]; then
  PYTEST_CMD="$PYTEST_CMD -m \"$PYTEST_MARKS\""
fi
if [ "${usage_cov}" = "true" ]; then
  uv sync --group test --inexact
  PYTEST_CMD="$PYTEST_CMD --cov=codeweaver --cov-report=xml --cov-report=term-missing --junit-xml=test-results.xml"
fi
PYTEST_CMD="$PYTEST_CMD -v \"\$@\""

eval "$PYTEST_CMD"
'''
run_windows = '''
echo [codeweaver] Running tests...
set PYTEST_MARKS=%usage_marks%
if "%usage_profile%"=="fast" (
    set PYTEST_MARKS=unit and not expensive and not requires_models
    echo [codeweaver] Running fast unit tests...
)
if "%usage_profile%"=="integration" (
    set PYTEST_MARKS=integration and not real_providers and not expensive
    echo [codeweaver] Running integration tests...
)
if "%usage_profile%"=="real" (
    set PYTEST_MARKS=real_providers
    echo [codeweaver] Running real provider tests...
)
if "%usage_profile%"=="heavy" (
    set PYTEST_MARKS=requires_models or expensive
    echo [codeweaver] Running heavy tests...
)
if "%usage_profile%"=="skip-list" (
    echo [codeweaver] Listing skipped tests...
    uv run pytest --collect-only -m "skip" %*
    exit /b 0
)
if "%usage_profile%"=="all" (
    echo [codeweaver] Running ALL tests...
)

if defined PYTEST_MARKS (
    set PYTEST_ARGS=-m "%PYTEST_MARKS%"
) else (
    set PYTEST_ARGS=
)
if "%usage_cov%"=="true" (
    uv sync --group test --inexact
    uv run pytest "%usage_dir%" %PYTEST_ARGS% --cov=codeweaver --cov-report=xml --cov-report=term-missing --junit-xml=test-results.xml -v %*
) else (
    uv run pytest "%usage_dir%" %PYTEST_ARGS% -v %*
)
'''

[tasks.test.env]
CODEWEAVER_TEST_MODE = "true"
PYTHONPATH = "src"

[tasks.test-cov]
env.PYTHONPATH = "src"
tools.uv = "latest"
tools.python = '''{{ get_env(name="MISE_PYTHON_VERSION", default="3.13") }}'''
run = '''
echo "${CW_PREFIX} Running tests with coverage..."
uv sync --group test --inexact
uv run pytest tests/ --cov=codeweaver --cov-report=xml --cov-report=term-missing --junit-xml=test-results.xml -v "$@"
'''
run_windows = '''
echo [codeweaver] Running tests with coverage...
uv sync --group test --inexact
uv run pytest tests/ --cov=codeweaver --cov-report=xml --cov-report=term-missing --junit-xml=test-results.xml -v %*
'''

[tasks.test-categories]
description = "Show test counts by category"
tools.uv = "latest"
tools.python = '''{{ get_env(name="MISE_PYTHON_VERSION", default="3.13") }}'''
run = '''
echo "${CW_PREFIX} Test counts by category:"
echo "${CW_PREFIX} Fast unit tests:"
uv run pytest --collect-only -q -m "unit and not expensive and not requires_models" | grep -E "(test session|tests collected)" || echo "  No matching tests"
echo ""
echo "${CW_PREFIX} Integration tests:"
uv run pytest --collect-only -q -m "integration and not real_providers and not expensive" | grep -E "(test session|tests collected)" || echo "  No matching tests"
echo ""
echo "${CW_PREFIX} Real provider tests:"
uv run pytest --collect-only -q -m "real_providers" | grep -E "(test session|tests collected)" || echo "  No matching tests"
echo ""
echo "${CW_PREFIX} Heavy tests:"
uv run pytest --collect-only -q -m "requires_models or expensive" | grep -E "(test session|tests collected)" || echo "  No matching tests"
'''
run_windows = '''
echo [codeweaver] Test counts by category:
echo [codeweaver] Fast unit tests:
uv run pytest --collect-only -q -m "unit and not expensive and not requires_models" | findstr /R "test.*session tests.*collected" || echo   No matching tests
echo.
echo [codeweaver] Integration tests:
uv run pytest --collect-only -q -m "integration and not real_providers and not expensive" | findstr /R "test.*session tests.*collected" || echo   No matching tests
echo.
echo [codeweaver] Real provider tests:
uv run pytest --collect-only -q -m "real_providers" | findstr /R "test.*session tests.*collected" || echo   No matching tests
echo.
echo [codeweaver] Heavy tests:
uv run pytest --collect-only -q -m "requires_models or expensive" | findstr /R "test.*session tests.*collected" || echo   No matching tests
'''

[tasks.clean]
usage = '''
flag "--deep" help="Perform deep clean (includes .venv and caches)"
flag "--venv-only" help="Only recreate virtual environment"
'''
run = '''
if [ "${usage_deep}" = "true" ]; then
    echo "${CW_PREFIX} Performing deep clean..."
    # First clean build artifacts
    rm -rf dist/ build/ *.egg-info/ .coverage test-results.xml
    find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
    find . -type f -name "*.pyc" -delete
    # Then clean caches and venv
    rm -rf .venv
    mise cache clear
    uv cache clean --force
    echo "${CW_PREFIX} ‚úÖ Deep clean complete! Recreating venv..."
    mise //:venv
elif [ "${usage_venv_only}" = "true" ]; then
    echo "${CW_PREFIX} Recreating virtual environment..."
    rm -rf .venv
    mise //:venv
else
    echo "${CW_PREFIX} Cleaning build artifacts..."
    rm -rf dist/ build/ *.egg-info/ .coverage test-results.xml &&
    find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true &&
    find . -type f -name "*.pyc" -delete &&
    echo "${CW_PREFIX} ‚úÖ Build artifacts cleaned!"
fi
'''
run_windows = '''
if "%usage_deep%"=="true" (
    echo [codeweaver] Performing deep clean...
    if exist dist rd /s /q dist
    if exist build rd /s /q build
    if exist *.egg-info rd /s /q *.egg-info
    if exist .coverage del .coverage
    if exist test-results.xml del test-results.xml
    for /d /r . %%d in (__pycache__) do @if exist "%%d" rd /s /q "%%d"
    del /s /q *.pyc 2>NUL
    rd /s /q .venv
    mise cache clear
    uv cache clean --force
    echo [codeweaver] Deep clean complete! Recreating venv...
    mise //:venv
) else if "%usage_venv_only%"=="true" (
    echo [codeweaver] Recreating virtual environment...
    rd /s /q .venv
    mise //:venv
) else (
    echo [codeweaver] Cleaning build artifacts...
    if exist dist rd /s /q dist
    if exist build rd /s /q build
    if exist *.egg-info rd /s /q *.egg-info
    if exist .coverage del .coverage
    if exist test-results.xml del test-results.xml
    for /d /r . %%d in (__pycache__) do @if exist "%%d" rd /s /q "%%d"
    del /s /q *.pyc 2>NUL
    echo [codeweaver] Build artifacts cleaned!
)
'''

# Release and maintenance
[tasks.version]
tools.uv = "latest"
run = '''
echo "${CW_PREFIX} CodeWeaver version information:"
echo "${CW_PREFIX} üì¶ Package version: $CODEWEAVER_VERSION"
echo "${CW_PREFIX} üêç Python version: $(python --version)"
echo "${CW_PREFIX} üåû UV version: $(uv --version)"
'''
run_windows = '''
echo [codeweaver] CodeWeaver version information:
echo [codeweaver] üì¶ Package version: %CODEWEAVER_VERSION%
for /f "delims=" %%v in ('python --version') do echo [codeweaver] Python version: %%v
for /f "delims=" %%v in ('uv --version') do echo [codeweaver] UV version: %%v
'''

[tasks.pre-commit]
env.MISE_EXPERIMENTAL = "1"
run = [
    "echo \"${CW_PREFIX} Running CodeWeaver pre-commit checks ü™ù... Thanks for your contributions! You're pretty cool. üöÄ\" || true",
    "mise //:format || echo \"${CW_PREFIX} ‚ö†Ô∏è  You need to fix some issues before committing. Do not pass go, do not collect 200 dollars. üí∏ üò¶\" && exit 1",
    "git add .",
    "git commit --amend --no-edit || true",
    "mise //:check || echo \"${CW_PREFIX} ‚ö†Ô∏è  You need to fix some issues before committing. Almost there!\" && exit 1",
    "echo \"${CW_PREFIX} ‚úÖ All pre-commit checks passed! You're awesome! üéâ ... and they said the Kobiyashi Maru was unwinnable! üññ\"",
]
run_windows = '''
echo [codeweaver] Running CodeWeaver pre-commit checks... Thanks for your contributions! You're pretty cool. üöÄ
mise //:format
if %ERRORLEVEL% neq 0 (
    echo [codeweaver] WARNING: You need to fix some issues before committing.
    exit /b 1
)
git add .
git commit --amend --no-edit || echo.
mise //:check
if %ERRORLEVEL% neq 0 (
    echo [codeweaver] WARNING: You need to fix some issues before committing. Almost there!
    exit /b 1
)
echo [codeweaver] All pre-commit checks passed! You're awesome!
'''

[tasks.activate]
run = '''eval "$(mise activate "$ACTIVE_SHELL")" &>/dev/null'''
run_windows = '''mise activate cmd'''
hide = true
env.ACTIVE_SHELL = '''{{ exec(command='basename "$SHELL" 2>/dev/null || echo zsh') }}'''

[tasks.activate-shims]
run = '''eval '"$(mise activate "${ACTIVE_SHELL:-zsh}" --shims)"' &>/dev/null'''
run_windows = '''mise activate cmd --shims'''
hide = true
env.ACTIVE_SHELL = '''{{ exec(command='basename "$SHELL" 2>/dev/null || echo bash') }}'''
