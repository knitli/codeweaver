# SPDX-FileCopyrightText: 2025 Knitli Inc.
# SPDX-FileContributor: Adam Poulemanos <adam@knit.li>
#
# SPDX-License-Identifier: MIT OR Apache-2.0
[settings]
idiomatic_version_file_enable_tools = []

[settings.python]
uv_venv_auto = true
compile = true
uv_venv_create_args = [
  "--seed",
  "--keyring-provider",
  "subprocess",
  "--python",
  "3.13",
]

[tools]
ast-grep = "latest"
"cargo:rust-parallel" = "latest"
"cargo:tree-sitter-cli" = "latest"
gh = "latest"
gitsign = "latest"
hk = "latest"
node = "24"
"pipx:changesets" = "latest"
"pipx:claude-monitor" = "latest"
"pipx:copychat" = "latest"
"pipx:git+https://github.com/microsoft/mcp-interviewer.git" = "latest"
"pipx:mike" = "latest"
"pipx:mteb" = "latest"
"pipx:reuse" = "latest"
"pipx:tombi" = "latest"
pkl = "latest"
ripgrep = "latest"
ruff = "latest"
shellcheck = "latest"
shfmt = "latest"
typos = "latest"
uv = "latest"
yamlfmt = "latest"

[hooks]
enter = """
#!/usr/bin/env zsh
# Set up git aliases
git config alias.root 'rev-parse --show-toplevel'
alias jj='jj --no-pager'
alias git='git --no-pager'
alias cdroot="cd "$(git root)" || true"

if [[ "$GITHUB_ACTIONS" == "true" ]]; then
    export CI=true
else
    export CI=false
fi

mise --silent set &>/dev/null
mise run source &>/dev/null
"""
leave = """
print -P "%F{209}[codeweaver]%f Exiting CodeWeaver environment..."
mise --silent -y deactivate &>/dev/null
print -P "%F{209}[codeweaver]%f Environment deactivated."
"""

[tasks]
[tasks.sync]
run = """
#!/bin/bash
echo "Syncing dependencies..."
uv sync --extra all --group all-dev
"""

[tasks.update-dependencies]
run = """
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Updating dependencies..."
uv sync --extra all --group all-dev -U
"""

[tasks.source]
run = """
#!/usr/bin/env zsh
# Source the virtual environment
print -P "%F{209}[codeweaver]%f Sourcing virtual environment..."
git rev-parse --show-toplevel || true
source .venv/bin/activate
"""

[tasks.setup]
# Development setup
run = """
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Setting up development environment for the first time..."
# Determine if we're in CI
# This doesn't change anything yet, but it's here for future use
if [[ "$GITHUB_ACTIONS" == true ]]; then
    export CI=true
else
    export CI=false
fi
mise --silent -y trust &>/dev/null &&
mise --silent -y install &>/dev/null || true &&
mise --silent reshim &&
eval "$(mise --silent activate zsh)" &&
eval "$(mise --silent env -s zsh)" &&
print -P "%F{209}[codeweaver]%f Initializing %F{209}CodeWeaver%f..."
if ! git config --local --get-all include.path | grep -qxF ".gitconfig" &>/dev/null; then
  print -P "%F{209}[codeweaver]%f Linking repo .gitconfig -> .git/config"
  git config --local --add include.path ".gitconfig" || true
fi
hk init --mise &>/dev/null || true &&
mise run venv || true &&
source .venv/bin/activate &
mise --silent -y run sync &
git config alias.root 'rev-parse --show-toplevel' &&
alias cdroot="cd "$(git root)" || true"
print -P "%F{209}[codeweaver]%f âœ… Development environment ready!"
"""

[tasks.update-tools]
run = """
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Updating tools..."
mise --silent -y upgrade &&
mise --silent self-update -yq &&
mise --silent reshim &&
mise --silent -y prune
print -P "%F{209}[codeweaver]%f âœ… Tools updated! ðŸ§°"
"""

[tasks.fix]
# Code quality and formatting
run = """
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Fixing code issues..."
ruff check --select I --fix . &&
ruff check --fix --unsafe-fixes src/ &&
scripts/code-quality/fix-ruff-patterns.sh src/ &&
ruff format . &&
hk fix &&
print -P "%F{209}[codeweaver]%f âœ… Code fixes applied!"
"""

[tasks.check]
run = """
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Running quality checks..."
hk check
"""

[tasks.lint]
run = """
#!/bin/bash
echo "Running linting checks..."
if [[ "$CI" == "true" ]]; then
    uv run ruff check . --output-format=github
else
    uv run ruff check .
fi
"""

[tasks.format]
run = """
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Running formatting checks..."
hk check
"""

[tasks.format-fix]
run = """
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Applying formatting...hold onto your butts ðŸš¬...ðŸ¦– "
mise run fix-ruff-patterns || {
    print -P "%F{209}[codeweaver]%f âš ï¸  %F{red}Ruff pattern fixer encountered issues.%f"}
uv run ruff format .
files="$(git ls-files '*.yaml' '*.yml' '*.json' 2>/dev/null)"
if [ -n "$files" ]; then
    echo "$files" | rust-parallel -d stderr -i - --no-run-if-empty yq -iP --indent=2 '.' || true
fi
files="$(git ls-files '*.toml' 2>/dev/null)"
if [ -n "$files" ]; then
    taplo format --in-place $files 2>/dev/null || true
fi
"""

[tasks.venv]
run = """
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Setting up Python virtual environment..."
uv venv --allow-existing --seed --keyring-provider subprocess --python 3.13 --refresh .venv &&
print -P "%F{209}[codeweaver]%f âœ… Virtual environment is ready!"
source .venv/bin/activate || print -P "%F{209}[codeweaver]%f âš ï¸  %F{red}Failed to source virtual environment.%f"
print -P "%F{209}[codeweaver]%f Running dependency sync..."
mise run sync
"""

[tasks.test]
# Testing
run = """
#!/bin/bash
echo "Running tests..."
uv run pytest tests/ -v
"""

[tasks.test-cov]
run = """
#!/bin/bash
echo "Running tests with coverage..."
uv run pytest tests/ --cov=codeweaver --cov-report=xml --cov-report=term-missing --junit-xml=test-results.xml -v
"""

[tasks.test-watch]
run = """
#!/bin/bash
echo "Running tests in watch mode..."
uv run pytest tests/ -f --tb=short
"""

[tasks.build]
# Building and packaging
run = """
#!/bin/bash
echo "Building package..."
uv build &&
echo "âœ… Package built successfully!"
"""

[tasks.clean]
run = """
#!/bin/bash
echo "Cleaning build artifacts..."
rm -rf dist/ build/ *.egg-info/ .coverage test-results.xml &&
find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true &&
find . -type f -name "*.pyc" -delete &&
echo "âœ… Build artifacts cleaned!"
"""

# Documentation
[tasks.docs-serve]
run = """
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Starting %F{209}CodeWeaver%f documentation server..."
uv run --group docs mkdocs serve
"""

[tasks.docs-build]
run = """
#!/bin/bash
echo "Building documentation..."
uv run --group docs mkdocs build
"""

# Release and maintenance
[tasks.version]
run = """
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver] CodeWeaver%f version information:"
print -P "%F{209}[codeweaver]%f ðŸ“¦ Package version: $(uv run python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")"
print -P "%F{209}[codeweaver]%f ðŸ Python version: $(python --version)"
print -P "%F{209}[codeweaver]%f ðŸŒž UV version: $(uv --version)"
"""

[tasks.changelog]
run = """
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Generating changelog..."
npm exec changeset version
"""

# Combined workflows
[tasks.ci]
run = """
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Running full CI pipeline locally..."
mise run check &&
mise run lint &&
mise run format &&
mise run test-cov &&
mise run build &&
print -P "%F{209}[codeweaver]%f âœ… All CI checks passed!"
"""

[tasks.pre-commit]
run = """
#!/usr/bin/env bash
print -P "%F{209}[codeweaver]%f Running %F{209}CodeWeaver%f pre-commit checks ðŸª... %F{38} Thanks for your contributions! You're pretty cool.%f ðŸš€" &&
hk fix || print -P "%F{209}[codeweaver]%f âš ï¸  %F{red}You need to fix some issues%f before committing. %F{209}Do not pass go, do not collect $200.%f ðŸ’¸ ðŸ˜¦" && exit 1
git add . &&
hk check || print -P "%F{209}[codeweaver]%f âš ï¸  %F{red}You need to fix some issues before committing. Almost there!%f" && exit 1
git add . &&
print -P "%F{209}[codeweaver]%f âœ… %F{green}All pre-commit checks passed! You're awesome!%f ðŸŽ‰ ... and they said the Kobiyashi Maru was unwinnable! ðŸ––"
"""

#! SECTION Aliases/Shortcuts for Scripts in scripts/ directory
[tasks.fix-ruff-patterns]
alias = "ruff-pats"
description = "Fix ruff unfixable patterns in the codebase"
run = """
#!/bin/bash
echo "Running ruff pattern fixer..."
./scripts/code-quality/fix-ruff-patterns.sh "${*}"
"""

[tasks.update-licenses]
run = """
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Updating %F{209}CodeWeaver%f license headers :..."
uv run -s scripts/code-quality/update-licenses.py --interactive "${*}"
"""

[tasks.dev-shell-init]
run = """
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Initializing development shell..."
./scripts/dev-env/dev-shell-init.zsh
"""

[tasks.install-mise]
run = """
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Installing Mise..."
./scripts/dev-env/install-mise.sh
"""

[tasks.vscode-terminal-bootstrap]
run = """
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Bootstrapping VSCode terminal..."
./scripts/dev-env/vscode-terminal-bootstrap.sh
"""

[tasks.add-plaintext-to-codeblock]
run = """
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Adding 'plaintext' to unmarked code blocks in markdown files..."
uv run -s scripts/docs/add-plaintext-to-codeblock.py
"""

[tasks.gen-ref-pages]
run = """
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Generating docs reference pages..."
uv run -s scripts/docs/gen-ref-pages.py
"""

[tasks.analyze-grammar-structure]
run = """
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Analyzing grammar structure..."
uv run -s scripts/language-support/analyze-grammar-structure.py
"""

[tasks.build-language-mappings]
run = """
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Building language mappings..."
uv run -s scripts/language-support/build-language-mappings.py
"""

[tasks.compare-delimiters]
run = """
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Comparing delimiters..."
uv run -s scripts/language-support/compare-delimiters.py
"""

[tasks.download-ts-grammars]
run = """
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Downloading tree-sitter grammars..."
uv run -s scripts/language-support/download-ts-grammars.py "${*}"
"""

[tasks.generate-delimiters]
run = """
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Generating delimiters..."
uv run -s scripts/language-support/generate-delimiters.py
"""

[tasks.generate-supported-languages]
run = """
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Generating supported languages..."
uv run -s scripts/build/generate-supported-languages.py
"""

[tasks.mteb-to-codeweaver]
run = """
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Converting MTEB model data to CodeWeaver format..."
uv run -s scripts/model-data/mteb-to-codeweaver.py "${*}"
"""

[tasks.apply-test-marks]
run = """
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Applying test marks to tests..."
uv run -s scripts/testing/apply-test-marks.py "${*}"
"""

[tasks.benchmark-detection]
run = """
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Running benchmark detection..."
uv run -s scripts/testing/benchmark-detection.py "${*}"
"""

[tasks.ansi-color-tests]
run = """
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Checking ANSI color codes..."
uv run -s scripts/utils/ansi-color-tests.py "${*}"
"""

[tasks.check-imports]
run = """
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Checking imports..."
uv run -s scripts/utils/check-imports.py "${*}"
"""

[tasks.get-all-exceptions]
run = """
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Getting all exceptions..."
uv run -s scripts/utils/get-all-exceptions.py "${*}"
"""

[tasks.activate]
run = """eval "$(mise activate)" &>/dev/null"""
hide = true
