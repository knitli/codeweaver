# SPDX-FileCopyrightText: 2025 Knitli Inc.
# SPDX-FileContributor: Adam Poulemanos <adam@knit.li>
#
# SPDX-License-Identifier: MIT OR Apache-2.0
#:tombi schema.strict = false

[project]
name = "codeweaver-mcp"
description = "Extensible MCP server for semantic code search with plugin architecture supporting multiple embedding providers, vector databases, and data sources."
readme = { file = "README.md", content-type = "text/markdown" }
requires-python = ">=3.12"
license = { text = "MIT OR Apache-2.0" }
authors = [
  { name = "Knitli Inc." },
  { name = "Adam Poulemanos", email = "adam@knit.li" },
]
keywords = [
  "agents",
  "ai",
  "anthropic",
  "artificial intelligence",
  "ast-grep",
  "azure",
  "bedrock",
  "claude",
  "code analysis",
  "code embeddings",
  "code indexing",
  "code intelligence",
  "code search",
  "code understanding",
  "codebase",
  "codebase analysis",
  "codebase management",
  "cohere",
  "docarray",
  "embedding",
  "embeddings",
  "extensible",
  "fastembed",
  "fastmcp",
  "framework",
  "genai",
  "google",
  "grok",
  "groq",
  "huggingface",
  "hybrid search",
  "information retrieval",
  "large language models",
  "llama",
  "llms",
  "mcp",
  "mcp protocol",
  "mcp server",
  "mistral",
  "model context protocol",
  "natural language processing",
  "nlp",
  "openai",
  "perplexity",
  "platform",
  "plugin architecture",
  "pydantic",
  "pydantic-ai",
  "qdrant",
  "rerank",
  "retrieval",
  "search",
  "semantic search",
  "sentence transformers",
  "tree-sitter",
  "vector",
  "vector database",
  "vector embeddings",
  "vector search",
  "vector store",
  "voyageai",
]
classifiers = [
  "Development Status :: 4 - Beta",
  "Environment :: Console",
  "Intended Audience :: Developers",
  "Intended Audience :: Information Technology",
  "Natural Language :: English",
  "Operating System :: OS Independent",
  "Programming Language :: Python :: 3 :: Only",
  "Programming Language :: Python :: 3.12",
  "Programming Language :: Python :: 3.13",
  "Programming Language :: Python :: 3.14",
  "Topic :: Database",
  "Topic :: Scientific/Engineering :: Artificial Intelligence",
  "Topic :: Scientific/Engineering :: Information Analysis",
  "Topic :: Software Development :: Libraries :: Application Frameworks",
  "Topic :: Software Development :: Libraries :: Python Modules",
  "Topic :: Text Processing :: Indexing",
  "Topic :: Utilities",
  "Typing :: Typed",
]
dependencies = [
  # Core functionality
  "aenum>=3.1.16",
  "ast-grep-py>=0.39.7",
  "blake3>=1.0.8",
  # CLI framework and output
  "cyclopts>=4.2.1",
  # MCP server framework
  "fastmcp>=2.13.0.2",
  "httpx>=0.28.1",
  "mcp>=1.19.0",
  # Numerical and ML
  "numpy>=2.3.4",
  # Infrastructure and utilities
  "posthog>=6.9.0",
  # Core data models and validation
  "pydantic>=2.12.4",
  "pydantic-ai>=1.10.0",
  "pydantic-graph>=1.10.0",
  "pydantic-settings[toml,yaml]>=2.11.0",  # Pulls: tomli>=2.0.1, pyyaml>=6.0.1
  "qdrant-client>=1.15.1",
  "rich>=14.2.0",
  "rignore>=0.7.6",
  "tenacity>=9.1.2",
  "textcase>=0.4.5",
  "tiktoken>=0.12.0",
  "tomli-w>=1.2.0",
  "typing_extensions>=4.15.0",
  "uuid7>=0.1.0; python_version < '3.14'",
  "uvicorn[standard]>=0.38.0",
  "voyageai>=0.3.5",
  "watchfiles>=1.1.1",
]
dynamic = ["version"]

[project.urls]
Changelog = "https://github.com/knitli/codeweaver-mcp/blob/main/CHANGELOG.md"
# Documentation = "https://dev.knitli.com/codeweaver" not live yet
Homepage = "https://knitli.com"
Issues = "https://github.com/knitli/codeweaver-mcp/issues"
Repository = "https://github.com/knitli/codeweaver-mcp"

[project.scripts]
codeweaver = "codeweaver.cli.__main__:main"

[project.optional-dependencies]
# eunomia middleware - see https://gofastmcp.com/integrations/eunomia-authorization
auth-eunomia = ["eunomia-mcp"]
# ==== Authentication and Authorization Middleware ====
# Optional middleware to add authentication and authorization capabilities to the CodeWeaver server.
# This allows you to secure your CodeWeaver instance with various authentication providers and authorization policies.
# The middleware can be used to enforce access control policies, authenticate users, and manage permissions.
# TODO: Implement authentication and authorization middleware -- should be simple to add
# permit.io middleware - see https://gofastmcp.com/integrations/permit
auth-permitio = ["permit-fastmcp"]
# ==== Authentication and Authorization Middleware/Addons ====
# Settings/Config Secrets
aws-secrets-manager = ["pydantic-settings[yaml,toml,aws-secrets-manager]"]
azure-key-vault = ["pydantic-settings[yaml,toml,azure-key-vault]"]
cli = ["cyclopts", "rich", "tomli-w"]
# workos AuthKit middleware - see https://gofastmcp.com/integrations/authkit
# No additional dependencies required, it's purely REST-based.
# Enable with environment variables:
#  ## Instruct FastMCP to use the AuthKit provider:
#    FASTMCP_SERVER_AUTH=AUTHKIT
#     configure the AuthKit provider
#     FASTMCP_SERVER_AUTH_AUTHKITPROVIDER_AUTHKIT_DOMAIN="https://your-project-12345.authkit.app"
#     FASTMCP_SERVER_AUTH_AUTHKITPROVIDER_BASE_URL="http://localhost:8000"
# All groups for users - full featured with all middleware
full = [
  "eunomia-mcp",
  "fastembed",
  "permit-fastmcp",
  "py-cpuinfo",
  "sentence-transformers[onnx]",
  "tokenizers",
]
full-gpu = [
  "eunomia-mcp",
  "fastembed-gpu",
  "permit-fastmcp",
  "py-cpuinfo",
  "sentence-transformers[onnx-gpu]",
  "tokenizers",
]
gcp-secret-manager = ["pydantic-settings[yaml,toml,gcp-secret-manager]"]
# ==== Providers ====
#    --- Agent-only Providers --- (no embedding/rerank)
provider-anthropic = ["pydantic-ai-slim[anthropic]"]
# --- Embedding, Rerank and Agent Providers --- (the trifecta)
provider-bedrock = ["pydantic-ai-slim[bedrock]"]
provider-cohere = ["pydantic-ai-slim[cohere]"]
# --- Embedding and Rerank Only --- (no agent)
provider-fastembed = ["fastembed", "py-cpuinfo"]
provider-fastembed-gpu = ["fastembed-gpu", "py-cpuinfo"]
provider-google = ["pydantic-ai-slim[google]"]
provider-groq = ["pydantic-ai-slim[groq]"]
# --- Embedding and Agent Providers --- (no rerank)
provider-huggingface = ["pydantic-ai-slim[huggingface]"]
# Requires additional setup, see https://qdrant.github.io/fastembed/examples/FastEmbed_GPU/
# ==== Vector Stores ====
provider-in-memory = ["qdrant-client", "tokenizers"]
provider-mistral = ["pydantic-ai-slim[mistral]"]
# OpenAI includes support for:
#   DeekSeek, Ollama, OpenRouter, Vercel, Perplexity, Moonshot, FireworksAI,
#   TogetherAI, Azure AI Foundry, Heroku, and Github Models, X-AI
# which all use the OpenAI API
provider-openai = ["pydantic-ai-slim[openai]"]
provider-qdrant = ["qdrant-client"]
provider-sentence-transformers = [
  "sentence-transformers",
  "py-cpuinfo",
]
provider-sentence-transformers-gpu = [
  "sentence-transformers[onnx-gpu]",
  "py-cpuinfo",
]
# disabled until we can fully integrate and resolve dependency conflicts
# provider-sentence-transformers-openvino = [
#     "sentence-transformers[openvino]",
#     "py-cpuinfo",
# ]
provider-voyageai = ["voyageai"]
recommended = [
  "fastembed",
  "py-cpuinfo",
  "tokenizers",
]
recommended-local-only = [
  "fastembed",
  "py-cpuinfo",
  "sentence-transformers",
  "tokenizers",
]
# ==== Data Sources ====
source-duckduckgo = ["pydantic-ai-slim[duckduckgo]"]
source-tavily = ["pydantic-ai-slim[tavily]"]

[dependency-groups]
dev = [
  "black>=25.9.0",
  "copychat>=0.7.2",
  "ipython>=9.6.0",
  "jsonlines>=4.0.0",
  "memory-profiler>=0.61.0",
  "mteb>=2.1.0",
  "pdbpp>=0.11.7",
  "pydantic-ai>=1.6.0",
  "pyperclip>=1.11.0",
  "ruff>=0.14.2",
  "superclaude>=4.1.6",
  "ty>=0.0.1a25",
  "types-boto3-custom",
  "uv>=0.9.5",
]
build = ["hatchling>=1.27.0", "twine>=6.2.0", "uv-dynamic-versioning>=0.11.2"]
docs = [
  "mkdocs>=1.6.1",
  "mkdocs-awesome-nav>=3.2.0",
  "mkdocs-gen-files>=0.5.0",
  "mkdocs-git-revision-date-localized-plugin>=1.5.0",
  # TODO: Add llms-txt to mkdocs.yml
  "mkdocs-llmstxt>=0.4.0",
  "mkdocs-material>=9.6.23",
  "mkdocs-minify-plugin>=0.8.0",
  "mkdocs-redirects>=1.2.2",
  "mkdocs-rss-plugin>=1.17.4",
  "mkdocstrings[python]>=0.30.1",
  "pygments>=2.19.2",
  "pymdown-extensions>=10.16.1",
]
test = [
  "dirty-equals>=0.10.0",
  "pdbpp>=0.11.7",
  "pytest>=8.4.2",
  "pytest-asyncio>=1.2.0",
  "pytest-cov>=7.0.0",
  "pytest-env>=1.2.0",
  "pytest-examples>=0.0.18",
  "pytest-flakefinder>=1.1.0",
  "pytest-httpx>=0.35.0",
  "pytest-mock>=3.15.1",
  "pytest-report>=0.2.1",
  "pytest-timeout>=2.4.0",
]

[build-system]
requires = ["hatchling>=1.27.0", "uv-dynamic-versioning>=0.11.2"]
build-backend = "hatchling.build"

# TODO: Integrate hatch plugins for:
#  - readme: https://github.com/hynek/hatch-fancy-pypi-readme

[tool.hatch.build.hooks.version]
additionalProperties = true
path = "src/codeweaver/_version.py"
template = '''# SPDX-FileCopyrightText: 2025 Knitli Inc.
# SPDX-License-Identifier: MIT OR Apache-2.0
"""Version information for CodeWeaver."""
from typing import Final


__version__: Final[str] = "{version}"

__all__ = ("__version__",)
'''

[tool.hatch.build.targets.wheel]
artifacts = ["*.so", "src/**"]
packages = ["src/codeweaver"]
include = ["node_types/**", "typings/**", "vendored/**"]

[tool.hatch.build.targets.sdist]
include = [
  ".gitignore",
  "ARCHITECTURE.md",
  "CHANGELOG.md",
  "CONTRIBUTORS_LICENSE_AGREEMENT.py",
  "LICENSE",
  "LICENSE-APACHE-2.0",
  "LICENSE-MIT",
  "README.md",
  "context7.json",
  "context7.json.license",
  "node_types/**",
  "pyproject.toml",
  "sbom.spdx",
  "src/**",
  "typings/**",
  "uv.lock",
  "uv.lock.license",
  "vendored/**",
]

[tool.hatch.version]
source = "uv-dynamic-versioning"

[tool.pytest.ini_options]
addopts = [
  "-ra",
  "--strict-markers",
  "--strict-config",
  "--cov=codeweaver",
  "--cov-report=term-missing",
  "--cov-report=html",
  "--cov-report=xml",
  "--cov-fail-under=80",
  "--import-mode=importlib",
]
filterwarnings = [
  "error",
  "ignore::UserWarning",
  "ignore::DeprecationWarning",
  "ignore::PendingDeprecationWarning",
]
markers = [
  # Test categories
  "unit: Unit tests that test individual components in isolation",
  "integration: Integration tests that test component interactions",
  "validation: Validation tests that ensure system consistency",
  "e2e: End-to-end tests that test complete workflows",
  # Performance & benchmarks
  "benchmark: Performance benchmark tests",
  "slow: Tests that take a significant amount of time to run",
  "performance: Performance-related tests",
  # External dependencies
  "real_providers: Tests that require real provider configurations",
  "network: Tests that require network access",
  "external_api: Tests that interact with external APIs",
  "voyageai: Tests that require VoyageAI API access",
  "qdrant: Tests that require Qdrant vector database",
  # Configuration & environment
  "config: Configuration-related tests",
  "env_vars: Tests that depend on environment variables",
  "mock_only: Tests that only use mocked dependencies",
  # Feature-specific
  "embeddings: Tests related to embedding functionality",
  "search: Tests related to search functionality",
  "indexing: Tests related to code indexing",
  "telemetry: Tests related to telemetry and metrics",
  "mcp: Tests related to MCP protocol functionality",
  "services: Tests related to services layer",
  "server: Tests related to server functionality",
  # Test types
  "parametrize: Parametrized tests with multiple test cases",
  "fixtures: Tests that heavily rely on pytest fixtures",
  "async_test: Asynchronous tests (in addition to pytest.mark.asyncio)",
  # Stability & reliability
  "flaky: Tests that may occasionally fail due to timing or external factors",
  "timeout: Tests with specific timeout requirements",
  "retry: Tests that may need retries",
  # Development & debugging
  "debug: Tests for debugging purposes",
  "dev_only: Tests that should only run in development",
  "skip_ci: Tests to skip in CI/CD environments",
]
minversion = "6.0"
python_classes = ["Test*"]
python_files = ["test_*.py", "*_test.py"]
python_functions = ["test_*"]
testpaths = ["tests"]
asyncio_mode = "auto"
timeout = 300
timeout_method = "thread"

[tool.ty.environment]
python-version = "3.12"
root = ["./src", "./tests", "./scripts", "./mise-tasks"]
python = "./.venv"
extra-paths = ["./vendored", "./typings"]

[tool.ty.rules]
# === Core Type Safety Rules (kept strict for src/) ===
# These remain as errors by default and will catch real bugs in production code

# === Test Framework Limitations ===
# ty doesn't understand pytest mocks/fixtures - these are inherent limitations, not real bugs
possibly-missing-attribute = "ignore"  # Pytest fixtures don't have static attributes
unresolved-attribute = "warn"  # Test mocks may have dynamic attributes
unknown-argument = "warn"  # Pytest fixtures injected dynamically
unresolved-reference = "warn"  # Test references may be dynamic

# === Type Inference Limitations ===
# ty is overly strict with Literal inference in dict lookups and dynamic patterns
invalid-argument-type = "warn"  # Many false positives in capabilities dicts and code gen
missing-typed-dict-key = "warn"  # Often false positive with dynamic TypedDict construction (e.g., **dict comprehension)

# === Style and Refactoring Suggestions ===
redundant-cast = "ignore"  # Informational only, not bugs

# === Optional Dependencies ===
# Scripts may import optional dependencies (e.g., mkdocs_gen_files, black)
unresolved-import = "warn"  # Downgrade to warn for optional dependencies

[tool.ty.src]
include = ["./src", "./tests", "./scripts", "./mise-tasks"]
# Exclude vendored code, typings, and intentionally malformed test fixtures
exclude = ["./typings", "./vendored", "./tests/fixtures/malformed.py"]

# === Per-Directory Overrides ===
# Apply different strictness levels: strict for src/, lenient for scripts/mise-tasks/tests

# Scripts: Code generation, build automation, documentation generation
# These often use dynamic patterns, optional dependencies, and intentional type flexibility
[[tool.ty.overrides]]
include = ["scripts/**/*.py"]

[tool.ty.overrides.rules]
invalid-assignment = "warn"
unresolved-import = "ignore"
invalid-argument-type = "ignore"
unresolved-reference = "ignore"
unresolved-attribute = "ignore"

# Mise Tasks: Build and diagnostic automation
# These are utility scripts with intentional dynamic behavior (e.g., monkey-patching warnings)
[[tool.ty.overrides]]
include = ["mise-tasks/**/*.py"]

[tool.ty.overrides.rules]
invalid-assignment = "ignore"
unresolved-import = "ignore"
invalid-argument-type = "ignore"
unresolved-reference = "ignore"

# Tests: May use pytest fixtures, mocks, and test-specific patterns
# Also may not have test dependencies installed when running ty in dev environment
# Tests can be less exact per the project requirements - focus on src/ strictness
[[tool.ty.overrides]]
include = ["tests/**/*.py"]

[tool.ty.overrides.rules]
unresolved-import = "ignore"  # pytest and other test dependencies may not be installed
unknown-argument = "ignore"  # pytest fixtures inject arguments dynamically
unresolved-reference = "ignore"  # test fixtures and dynamic test patterns
unresolved-attribute = "ignore"  # mocks and fixtures have dynamic attributes
non-subscriptable = "warn"  # Often false positive after pytest assertions
unsupported-operator = "warn"  # Type narrowing after assertions not always understood
missing-argument = "warn"  # Dynamic test patterns and fixtures
too-many-positional-arguments = "warn"  # Dynamic function calls in tests
invalid-assignment = "warn"  # Test setup patterns

# Test Fixtures: Intentionally malformed or edge-case test data
# These may have type errors by design to test error handling
[[tool.ty.overrides]]
include = ["tests/fixtures/**/*.py"]

[tool.ty.overrides.rules]
invalid-assignment = "ignore"
invalid-argument-type = "ignore"
unresolved-reference = "ignore"

[tool.uv.sources]
types-boto3-custom = { path = "vendored/types_boto3_custom-1.40.16-py3-none-any.whl" }

[tool.uv-dynamic-versioning]
vcs = "git"
style = "semver"
bump = true
dirty = true  # Add .dirty suffix when working directory has uncommitted changes
# tag-branch = "main"  # Commented out to allow building on feature branches
commit-prefix = "g"
