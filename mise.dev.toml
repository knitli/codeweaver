# SPDX-FileCopyrightText: 2025 Knitli Inc.
# SPDX-FileContributor: Adam Poulemanos <adam@knit.li>
#
# SPDX-License-Identifier: MIT OR Apache-2.0

[settings.python]
uv_venv_auto = true
compile = true

[tools]
hk = { version = "latest" }
pkl = "latest"
usage = "latest"
uv = "latest"
# Quality & validation tools
"pipx:reuse" = "latest"  # License validation
"aqua:tombi-toml/tombi" = "latest"
"pipx:ty" = "latest"  # Type checking
ruff = "latest"  # Python linting/formatting

[env]
_.python.venv = { path = ".venv", create = true, uv_create_args = [
  "--seed",
  "--keyring-provider",
  "subprocess",
  "--python",
  '{{ get_env(name="MISE_PYTHON_VERSION", default="3.13") }}'
] }

[hooks]
[hooks.enter]
env.MISE_EXPERIMENTAL = "1"
script = '''
'''

[tasks]
[tasks.enter]
silent = "stdout"
tools.uv = "latest"
run = '''
# profile is set to 'dev' in a cloud CI environment for cloud agents. 'enter' tends to break there.
if [ "$profile" != "dev" ] && [ "$CI" != "true" ]; then
    # don't run
    exit 0
fi
case "$python_path" in
*.venv/bin/python*)
    # Already in venv, do nothing
    ;;
*)
    # Not in venv or python not found, source it
    source .venv/bin/activate 2>/dev/null || true
    ;;
esac
'''
run_windows = '''
@echo off
set "pythonPath=%python_path%"
if not %profile%==dev if not "%CI%"=="true" (
    rem don't run
    exit /b 0
)
if not "%pythonPath%"=="%pythonPath:.venv\Scripts\python=%" (
    rem Already in venv, do nothing
) else (
    rem Not in venv or python not found, source it
    if exist .venv\Scripts\activate.bat (
        call .venv\Scripts\activate.bat 2>NUL
    )
)
'''

[tasks.enter.env]
ACTIVE_SHELL = '''{{ exec(command='basename "$SHELL" 2>/dev/null || echo zsh') }}'''
python_path = '''{{ exec(command='command -v python 2>/dev/null || echo ""') }}'''
MISE_EXPERIMENTAL = "1"

[tasks.cloud-setup]
run = [
  "echo \"[codeweaver] Setting up cloud development environment...\"",
  "ln -sf AGENTS.md CLAUDE.md",
  '''if ! command -v mise &>/dev/null; then
      if [ -d "$HOME/.local/share/mise" ] || [ -d "$HOME/.mise" ] || [ -f "$HOME/.local/bin/mise" ]; then
        export PATH="$HOME/.local/bin:$HOME/.mise/bin:$HOME/.local/share/mise/bin:$PATH"
        if [ "ACTIVE_SHELL" = "bash" ] || [ "ACTIVE_SHELL" = "zsh" ] && ! grep -q "mise activate" "$HOME/.${ACTIVE_SHELL}rc"; then
          echo "eval \"$(mise activate \"${ACTIVE_SHELL}\")\" 2>&1 || true" >> "$HOME/.${ACTIVE_SHELL}rc"
        fi
      else
        chmod +x scripts/dev-env/install-mise.sh 2>&1 || true
        ./scripts/dev-env/install-mise.sh 2>&1 || true
      fi
  fi''',
  '''mise trust --all 2>&1 || { echo "[WARNING] mise trust --all failed during cloud-setup" >&2; }''',
  '''mise install 2>&1 || { echo "[WARNING] mise install failed during cloud-setup" >&2; }''',
  '''mise x hk@latest -- hk install --mise 2>&1 || { echo "[WARNING] hk install failed during cloud-setup" >&2; }''',
  "mise x uv@latest -- uv venv --allow-existing --seed --keyring-provider subprocess --python {{ get_env(name='MISE_PYTHON_VERSION', default='3.13') }} .venv 2>&1",
  ". .venv/bin/activate 2>&1 || true",
  "mise x uv@latest -- uv sync --extra full --group dev --group test 2>&1",
  "git config include.path .gitconfig 2>&1 || true",
  '''bash -c "
  ignore_files=('src/codeweaver/_version.py' 'coverage.xml' 'test-results.xml')
  for file in \"\${ignore_files[@]}\"; do
    if ! grep -qx \"\$file\" .git/info/exclude; then
      echo \"\$file\" >> .git/info/exclude 2>&1
    fi
  done
  "''',
  "echo \"[codeweaver] Cloud development environment setup complete!\"",
]

[tasks.cloud-setup.env]
ACTIVE_SHELL = '''{{ exec(command='basename "$SHELL" 2>/dev/null || echo bash') }}'''
MISE_EXPERIMENTAL = "1"
MISE_ENV = "dev"
MISE_YES = "1"

[tasks.update-dependencies]
tools.uv = "latest"
depends = ["source"]
run = '''#!/usr/bin/env zsh
echo "${CW_PREFIX} Updating dependencies..."
uv sync --extra full --group dev --group docs --group build --group test -U'''
run_windows = '''
echo [codeweaver] Updating dependencies...
uv sync --extra full --group dev --group docs --group build --group test -U
'''

[tasks.update]
silent = "stdout"
alias = "update-tools"
shell = "zsh -c"
env.MISE_EXPERIMENTAL = "1"
env.MISE_YES = "1"
run = [
  "echo \"${CW_PREFIX} Updating tools...\"",
  "mise upgrade",
  "mise self-update",
  "mise prune",
  "mise reshim",
  "echo \"${CW_PREFIX} âœ… Tools updated! ğŸ§°\"",
]
run_windows = [
  "echo [codeweaver] Updating tools...",
  "mise upgrade",
  "mise self-update",
  "mise prune",
  "mise reshim",
  "echo [codeweaver] Tools updated!",
]

[tasks.test-watch]
tools.uv = "latest"
run = '''
echo "${CW_PREFIX} Running tests in watch mode..."
uv run pytest tests/ -f --tb=short
'''
run_windows = '''
echo [codeweaver] Running tests in watch mode...
uv run pytest tests/ -f --tb=short
'''

[tasks.build]
# Building and packaging
run = '''
echo "${CW_PREFIX} Building package..."
uv build 2>&1 &&
echo "${CW_PREFIX} âœ… Package built successfully!"
'''
run_windows = '''
echo [codeweaver] Building package...
uv build
if %ERRORLEVEL% equ 0 (
    echo [codeweaver] Package built successfully!
)
'''

# Documentation
[tasks.docs-dev]
tools.uv = "latest"
env.MISE_EXPERIMENTAL = "1"
run = '''
echo "${CW_PREFIX} Starting CodeWeaver documentation server..."
mise //:docs-site/dev || true
'''
run_windows = '''
echo [codeweaver] Starting CodeWeaver documentation server...
mise //:docs-site/dev || exit /b 0
'''

[tasks.changelog]
description = "Generate a filtered, PR-focused changelog (output to stdout)"
tools.git-cliff = "latest"
run = '''
echo "${CW_PREFIX} Generating changelog..."
git-cliff
'''

[tasks.changelog-unreleased]
description = "Generate changelog for unreleased changes (output to stdout)"
tools.git-cliff = "latest"
run = '''
echo "${CW_PREFIX} Generating unreleased changelog..."
git-cliff --unreleased
'''

[tasks.changelog-update]
description = "Update CHANGELOG.md with unreleased changes"
tools.git-cliff = "latest"
run = '''
echo "${CW_PREFIX} Updating CHANGELOG.md with unreleased changes..."
git-cliff --unreleased --prepend --output CHANGELOG.md &&
echo "${CW_PREFIX} âœ… CHANGELOG.md updated!"
'''

[tasks.changelog-tag]
description = "Generate changelog for a specific tag"
usage = '''
arg "<tag>" help="Git tag to generate changelog for (e.g., v0.1.0)"
'''
tools.git-cliff = "latest"
run = '''
echo "${CW_PREFIX} Generating changelog for tag ${usage_tag:?}..."
git-cliff --tag "${usage_tag:?}" --prepend --output CHANGELOG.md &&
echo "${CW_PREFIX} âœ… CHANGELOG.md generated for ${usage_tag:?}!"
'''

[tasks.prepare-version]
description = "Prepare build artifacts for a new version release"
usage = '''
arg "[version]" help="Version to prepare (e.g., 1.2.0). If not provided, will prompt."
flag "--no-commit" help="Don't commit the changes, just generate artifacts"
flag "--no-tag" help="Don't create a git tag"
flag "--push" help="Push changes and tags to remote after committing"
'''
run = '''
#!/usr/bin/env bash
set -e

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${CW_PREFIX} Preparing version release..."

# Get version
VERSION="${usage_version:-}"
if [ -z "$VERSION" ]; then
    read -p "Enter version number (e.g., 1.2.0): " VERSION
fi

# Validate version format (supports pre-release: 1.2.0-alpha.1, 1.2.0-beta.2, etc.)
if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9._-]+)?$ ]]; then
    echo -e "${RED}Error: Invalid version format. Use semantic versioning (e.g., 1.2.0 or 1.2.0-alpha.1)${NC}"
    exit 1
fi

echo -e "${CW_PREFIX} Preparing version ${GREEN}v${VERSION}${NC}..."

# Step 1: Run build preparation
echo -e "${CW_PREFIX} Step 1/7: Running build preparation..."
uv run python scripts/build/prepare-build.py || {
    echo -e "${RED}Build preparation failed!${NC}"
    exit 1
}

# Step 2: Check for generated artifacts
echo -e "${CW_PREFIX} Step 2/7: Verifying generated artifacts..."
if [ ! -f "src/codeweaver/data/node_types_cache.pkl" ]; then
    echo -e "${YELLOW}Warning: node_types_cache.pkl not found${NC}"
fi

# Step 3: Update CHANGELOG
echo -e "${CW_PREFIX} Step 3/7: Updating CHANGELOG.md..."
git cliff --unreleased --bump --prepend CHANGELOG.md || {
    echo -e "${YELLOW}Warning: Failed to update CHANGELOG${NC}"
}

# Step 4: Ensure Reuse coverage
echo -e "${CW_PREFIX} Step 4/7: Ensuring Reuse coverage..."
reuse lint || {
    echo -e "${RED}Reuse lint failed!${NC}"
    exit 1
}

# Step 5: Generate SBOM
echo -e "${CW_PREFIX} Step 5/7: Generating SBOM for version ${VERSION}..."
reuse spdx --add-license-concluded --creator-person "automated[bot]" --creator-organization "Knitli Inc." -o sbom.spdx || {
    echo -e "${RED}SBOM generation failed!${NC}"
    exit 1
}

# Step 6: Commit if not disabled
if [ -z "${usage_no_commit:-}" ]; then
    echo -e "${CW_PREFIX} Step 6/7: Committing build artifacts..."
    git add src/codeweaver/data/node_types_cache.pkl 2>/dev/null || true
    git add CHANGELOG.md 2>/dev/null || true
    git add schema/ 2>/dev/null || true

    if ! git diff --cached --quiet; then
        git commit -m "chore: prepare build artifacts for v${VERSION}

- Update node_types cache
- Generate schema for v${VERSION}
- Update CHANGELOG.md" || {
            echo -e "${RED}Commit failed!${NC}"
            exit 1
        }
        echo -e "${GREEN}âœ“ Build artifacts committed${NC}"
    else
        echo -e "${YELLOW}No changes to commit${NC}"
    fi
else
    echo -e "${YELLOW}Skipping commit (--no-commit flag)${NC}"
fi

# Step 7: Tag if not disabled
if [ -z "${usage_no_tag:-}" ] && [ -z "${usage_no_commit:-}" ]; then
    echo -e "${CW_PREFIX} Step 7/7: Creating git tag v${VERSION}..."
    git tag -a "v${VERSION}" -m "Release v${VERSION}" || {
        echo -e "${RED}Tagging failed!${NC}"
        exit 1
    }
    echo -e "${GREEN}âœ“ Created tag v${VERSION}${NC}"
else
    echo -e "${YELLOW}Skipping tag creation${NC}"
fi

# Push if requested
if [ -n "${usage_push:-}" ]; then
    echo -e "${CW_PREFIX} Pushing to remote..."
    git push && git push --tags || {
        echo -e "${RED}Push failed!${NC}"
        exit 1
    }
    echo -e "${GREEN}âœ“ Pushed to remote${NC}"
fi

echo ""
echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}âœ“ Version ${VERSION} prepared successfully!${NC}"
echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
echo -e "${BLUE}Next steps:${NC}"
if [ -z "${usage_push:-}" ]; then
    echo -e "  1. Review the changes: ${YELLOW}git show${NC}"
    echo -e "  2. Push to remote: ${YELLOW}git push && git push --tags${NC}"
fi
echo -e "  3. Create GitHub release from tag v${VERSION}"
echo ""
'''
run_windows = '''
echo [codeweaver] Version preparation on Windows not yet supported. Use WSL or Linux.
exit 1
'''

[tasks.prepare-version.tools]
"cargo:tree-sitter-cli" = "latest"
"pipx:reuse" = "latest"
git-cliff = "latest"
usage = "latest"
uv = "latest"

[tasks.prepare-version.env]
GITHUB_REPO = "knitli/codeweaver"
GITHUB_TOKEN = "{{ get_env(name='MISE_GITHUB_TOKEN', default='') }}"
MISE_ENV = "dev"
GIT_CLIFF_REPOSITORY = "{{ get_env(name='CODEWEAVER_PROJECT_PATH', default=config_root)  }}"
