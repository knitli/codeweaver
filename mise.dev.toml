# SPDX-FileCopyrightText: 2025 Knitli Inc.
# SPDX-FileContributor: Adam Poulemanos <adam@knit.li>
#
# SPDX-License-Identifier: MIT OR Apache-2.0
[settings]
status.show_env = true

[tools]
"cargo:rust-parallel" = "latest"
"cargo:tree-sitter-cli" = "latest"
"pipx:claude-monitor" = "latest"
"pipx:copychat" = "latest"
"pipx:fastmcp" = "latest"
"pipx:git+https://github.com/microsoft/mcp-interviewer.git" = "latest"
"pipx:mike" = "latest"
"pipx:mteb" = "latest"
"pipx:reuse" = "latest"
"pipx:tombi" = "latest"
"pipx:ty" = "latest"
ast-grep = "latest"
gh = "latest"
gitsign = "latest"
hk = "latest"
node = "24"
ripgrep = "latest"
ruff = "latest"
shellcheck = "latest"
shfmt = "latest"
typos = "latest"
usage = "latest"
uv = "latest"
yq = "latest"
git-cliff = "latest"

[env]
_.path = [
  "scripts/dev-env",
  "scripts/code-quality",
  "scripts/build",
  "scripts/language-support",
  "scripts/testing",
  "scripts/utils",
  ".venv/bin",
]
MISE_ENV = "dev"

[hooks]
[hooks.enter]
script = "mise run enter"

[tasks]
[tasks.enter]
shell = "zsh -c"
silent = "stdout"
run = '''
case "$python_path" in
*.venv/bin/python*)
    # Already in venv, do nothing
    ;;
*)
    # Not in venv or python not found, source it
    source .venv/bin/activate 2>/dev/null || true
    ;;
esac
'''
run_windows = '''
@echo off
set "pythonPath=%python_path%"
if not "%pythonPath%"=="%pythonPath:.venv\Scripts\python=%" (
    rem Already in venv, do nothing
) else (
    rem Not in venv or python not found, source it
    if exist .venv\Scripts\activate.bat (
        call .venv\Scripts\activate.bat 2>NUL
    )
)
'''

[tasks.enter.env]
ACTIVE_SHELL = '''{{ exec(command='basename "$SHELL" 2>/dev/null || echo zsh') }}'''
python_path = '''{{ exec(command='command -v python 2>/dev/null || echo ""') }}'''

[tasks.update-dependencies]
tools.uv = "latest"
depends = ["source"]
run = '''
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Updating dependencies..."
uv sync --extra full --group dev --group docs --group build --group test -U
'''
run_windows = '''
echo [codeweaver] Updating dependencies...
uv sync --extra full --group dev --group docs --group build --group test -U
'''

[tasks.update]
silent = "stdout"
alias = "update-tools"
shell = "zsh -c"
run = [
  "print -P \"%F{209}[codeweaver]%f Updating tools...\"",
  "mise -y upgrade",
  "mise -y self-update",
  "mise -y reshim",
  "mise -y prune",
  "print -P \"%F{209}[codeweaver]%f âœ… Tools updated! ğŸ§°\"",
]
run_windows = [
  "echo [codeweaver] Updating tools...",
  "mise -y upgrade",
  "mise -y self-update",
  "mise -y reshim",
  "mise -y prune",
  "echo [codeweaver] Tools updated!",
]

[tasks.test-watch]
run = '''
#!/bin/bash
echo "Running tests in watch mode..."
uv run pytest tests/ -f --tb=short
'''
run_windows = '''
echo Running tests in watch mode...
uv run pytest tests/ -f --tb=short
'''

[tasks.build]
# Building and packaging
run = '''
#!/bin/bash
echo "Building package..."
uv build &&
echo "âœ… Package built successfully!"
'''
run_windows = '''
echo Building package...
uv build
if %ERRORLEVEL% equ 0 (
    echo Package built successfully!
)
'''

# Documentation
[tasks.docs-serve]
tools.uv = "latest"
run = '''
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Starting %F{209}CodeWeaver%f documentation server..."
uv run --group docs mkdocs serve
'''
run_windows = '''
echo [codeweaver] Starting CodeWeaver documentation server...
uv run --group docs mkdocs serve
'''

[tasks.docs-build]
tools.uv = "latest"
run = '''
#!/bin/bash
echo "Building documentation..."
uv run --group docs mkdocs build
'''
run_windows = '''
echo Building documentation...
uv run --group docs mkdocs build
'''

[tasks.changelog]
description = "Generate a filtered, PR-focused changelog (output to stdout)"
tools.git-cliff = "latest"
run = '''
#!/usr/bin/env bash
echo "Generating changelog..."
git-cliff
'''

[tasks.changelog-unreleased]
description = "Generate changelog for unreleased changes (output to stdout)"
tools.git-cliff = "latest"
run = '''
#!/usr/bin/env bash
echo "Generating unreleased changelog..."
git-cliff --unreleased
'''

[tasks.changelog-update]
description = "Update CHANGELOG.md with unreleased changes"
tools.git-cliff = "latest"
run = '''
#!/usr/bin/env bash
echo "Updating CHANGELOG.md with unreleased changes..."
git-cliff --unreleased --prepend --output CHANGELOG.md &&
echo "âœ… CHANGELOG.md updated!"
'''

[tasks.changelog-tag]
description = "Generate changelog for a specific tag"
usage = '''
arg "<tag>" {
  help = "Git tag to generate changelog for (e.g., v0.1.0)"
}
'''
tools.git-cliff = "latest"
run = '''
#!/usr/bin/env bash
echo "Generating changelog for tag ${usage_tag:?}..."
git-cliff --tag "${usage_tag:?}" --prepend --output CHANGELOG.md &&
echo "âœ… CHANGELOG.md generated for ${usage_tag:?}!"
'''

[tasks.prepare-version]
tools.git-cliff = "latest"
description = "Prepare build artifacts for a new version release"
usage = '''
arg "[version]" {
  help = "Version to prepare (e.g., 1.2.0). If not provided, will prompt."
}
flag "--no-commit" {
  help = "Don't commit the changes, just generate artifacts"
}
flag "--no-tag" {
  help = "Don't create a git tag"
}
flag "--push" {
  help = "Push changes and tags to remote after committing"
}
'''
run = '''
#!/usr/bin/env bash
set -e

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${BLUE}[codeweaver]${NC} Preparing version release..."

# Get version
VERSION="${usage_version:-}"
if [ -z "$VERSION" ]; then
    read -p "Enter version number (e.g., 1.2.0): " VERSION
fi

# Validate version format
if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo -e "${RED}Error: Invalid version format. Use semantic versioning (e.g., 1.2.0)${NC}"
    exit 1
fi

echo -e "${BLUE}[codeweaver]${NC} Preparing version ${GREEN}v${VERSION}${NC}..."

# Step 1: Run build preparation
echo -e "${BLUE}[codeweaver]${NC} Step 1/7: Running build preparation..."
uv run python scripts/build/prepare-build.py || {
    echo -e "${RED}Build preparation failed!${NC}"
    exit 1
}

# Step 2: Check for generated artifacts
echo -e "${BLUE}[codeweaver]${NC} Step 2/7: Verifying generated artifacts..."
if [ ! -f "src/codeweaver/data/node_types_cache.pkl" ]; then
    echo -e "${YELLOW}Warning: node_types_cache.pkl not found${NC}"
fi

# Step 3: Update CHANGELOG
echo -e "${BLUE}[codeweaver]${NC} Step 3/7: Updating CHANGELOG.md..."
git-cliff --tag "v${VERSION}" --prepend --output CHANGELOG.md || {
    echo -e "${YELLOW}Warning: Failed to update CHANGELOG${NC}"
}

# Step 4: Ensure Reuse coverage
echo -e "${BLUE}[codeweaver]${NC} Step 4/7: Ensuring Reuse coverage..."
reuse lint || {
    echo -e "${RED}Reuse lint failed!${NC}"
    exit 1
}

# Step 5: Generate SBOM
echo -e "${BLUE}[codeweaver]${NC} Step 5/7: Generating SBOM for version ${VERSION}..."
reuse spdx --add-license-concluded --creator-person "automated[bot]" --creator-organization "Knitli Inc." -o sbom.spdx || {
    echo -e "${RED}SBOM generation failed!${NC}"
    exit 1
}

# Step 6: Commit if not disabled
if [ -z "${usage_no_commit:-}" ]; then
    echo -e "${BLUE}[codeweaver]${NC} Step 6/7: Committing build artifacts..."
    git add src/codeweaver/data/node_types_cache.pkl 2>/dev/null || true
    git add CHANGELOG.md 2>/dev/null || true
    git add schema/ 2>/dev/null || true

    if ! git diff --cached --quiet; then
        git commit -m "chore: prepare build artifacts for v${VERSION}

- Update node_types cache
- Generate schema for v${VERSION}
- Update CHANGELOG.md" || {
            echo -e "${RED}Commit failed!${NC}"
            exit 1
        }
        echo -e "${GREEN}âœ“ Build artifacts committed${NC}"
    else
        echo -e "${YELLOW}No changes to commit${NC}"
    fi
else
    echo -e "${YELLOW}Skipping commit (--no-commit flag)${NC}"
fi

# Step 7: Tag if not disabled
if [ -z "${usage_no_tag:-}" ] && [ -z "${usage_no_commit:-}" ]; then
    echo -e "${BLUE}[codeweaver]${NC} Step 7/7: Creating git tag v${VERSION}..."
    git tag -a "v${VERSION}" -m "Release v${VERSION}" || {
        echo -e "${RED}Tagging failed!${NC}"
        exit 1
    }
    echo -e "${GREEN}âœ“ Created tag v${VERSION}${NC}"
else
    echo -e "${YELLOW}Skipping tag creation${NC}"
fi

# Push if requested
if [ -n "${usage_push:-}" ]; then
    echo -e "${BLUE}[codeweaver]${NC} Pushing to remote..."
    git push && git push --tags || {
        echo -e "${RED}Push failed!${NC}"
        exit 1
    }
    echo -e "${GREEN}âœ“ Pushed to remote${NC}"
fi

echo ""
echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}âœ“ Version ${VERSION} prepared successfully!${NC}"
echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
echo -e "${BLUE}Next steps:${NC}"
if [ -z "${usage_push:-}" ]; then
    echo -e "  1. Review the changes: ${YELLOW}git show${NC}"
    echo -e "  2. Push to remote: ${YELLOW}git push && git push --tags${NC}"
fi
echo -e "  3. Create GitHub release from tag v${VERSION}"
echo ""
'''
run_windows = '''
echo [codeweaver] Version preparation on Windows not yet supported. Use WSL or Linux.
exit 1
'''

[tasks.prepare-version.env]
GITHUB_REPO = "knitli/codeweaver"
GITHUB_TOKEN = "{{ get_env(name='MISE_GITHUB_TOKEN', default='') }}"
MISE_ENV = "dev"
GIT_CLIFF_REPOSITORY = "{{ config_root }}"
