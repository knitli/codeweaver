# SPDX-FileCopyrightText: 2025 Knitli Inc.
# SPDX-FileContributor: Adam Poulemanos <adam@knit.li>
#
# SPDX-License-Identifier: MIT OR Apache-2.0
[settings]
status.show_env = true

[tools]
"cargo:rust-parallel" = "latest"
"cargo:tree-sitter-cli" = "latest"
"pipx:changesets" = "latest"
"pipx:claude-monitor" = "latest"
"pipx:copychat" = "latest"
"pipx:fastmcp" = "latest"
"pipx:git+https://github.com/microsoft/mcp-interviewer.git" = "latest"
"pipx:mike" = "latest"
"pipx:mteb" = "latest"
"pipx:reuse" = "latest"
"pipx:tombi" = "latest"
"pipx:ty" = "latest"
ast-grep = "latest"
gh = "latest"
gitsign = "latest"
hk = "latest"
node = "24"
ripgrep = "latest"
ruff = "latest"
shellcheck = "latest"
shfmt = "latest"
typos = "latest"
usage = "latest"
uv = "latest"
"npm:changesets" = "latest"
yq = "latest"

[env]
_.path = [
  "scripts/dev-env",
  "scripts/code-quality",
  "scripts/build",
  "scripts/language-support",
  "scripts/testing",
  "scripts/utils",
  ".venv/bin",
]
MISE_ENV = "dev"

[hooks]
[hooks.enter]
script = "mise run enter"

[tasks]
[tasks.enter]
shell = "zsh -c"
silent = "stdout"
run = '''
case "$python_path" in
*.venv/bin/python*)
    # Already in venv, do nothing
    ;;
*)
    # Not in venv or python not found, source it
    source .venv/bin/activate 2>/dev/null || true
    ;;
esac
'''
run_windows = '''
@echo off
set "pythonPath=%python_path%"
if not "%pythonPath%"=="%pythonPath:.venv\Scripts\python=%" (
    rem Already in venv, do nothing
) else (
    rem Not in venv or python not found, source it
    if exist .venv\Scripts\activate.bat (
        call .venv\Scripts\activate.bat 2>NUL
    )
)
'''

[tasks.enter.env]
ACTIVE_SHELL = '''{{ exec(command='basename "$SHELL" 2>/dev/null || echo zsh') }}'''
python_path = '''{{ exec(command='command -v python 2>/dev/null || echo ""') }}'''

[tasks.update-dependencies]
tools.uv = "latest"
depends = ["source"]
run = '''
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Updating dependencies..."
uv sync --extra full --group dev --group docs --group build --group test -U
'''
run_windows = '''
echo [codeweaver] Updating dependencies...
uv sync --extra full --group dev --group docs --group build --group test -U
'''

[tasks.update]
silent = "stdout"
alias = "update-tools"
shell = "zsh -c"
run = [
  "print -P \"%F{209}[codeweaver]%f Updating tools...\"",
  "mise -y upgrade",
  "mise -y self-update",
  "mise -y reshim",
  "mise -y prune",
  "print -P \"%F{209}[codeweaver]%f âœ… Tools updated! ðŸ§°\"",
]
run_windows = [
  "echo [codeweaver] Updating tools...",
  "mise -y upgrade",
  "mise -y self-update",
  "mise -y reshim",
  "mise -y prune",
  "echo [codeweaver] Tools updated!",
]

[tasks.test-watch]
run = '''
#!/bin/bash
echo "Running tests in watch mode..."
uv run pytest tests/ -f --tb=short
'''
run_windows = '''
echo Running tests in watch mode...
uv run pytest tests/ -f --tb=short
'''

[tasks.build]
# Building and packaging
run = '''
#!/bin/bash
echo "Building package..."
uv build &&
echo "âœ… Package built successfully!"
'''
run_windows = '''
echo Building package...
uv build
if %ERRORLEVEL% equ 0 (
    echo Package built successfully!
)
'''

# Documentation
[tasks.docs-serve]
tools.uv = "latest"
run = '''
#!/usr/bin/env zsh
print -P "%F{209}[codeweaver]%f Starting %F{209}CodeWeaver%f documentation server..."
uv run --group docs mkdocs serve
'''
run_windows = '''
echo [codeweaver] Starting CodeWeaver documentation server...
uv run --group docs mkdocs serve
'''

[tasks.docs-build]
tools.uv = "latest"
run = '''
#!/bin/bash
echo "Building documentation..."
uv run --group docs mkdocs build
'''
run_windows = '''
echo Building documentation...
uv run --group docs mkdocs build
'''
