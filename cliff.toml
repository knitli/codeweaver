# SPDX-FileCopyrightText: 2025 Knitli Inc.
# SPDX-FileContributor: Adam Poulemanos <adam@knit.li>
#
# SPDX-License-Identifier: MIT OR Apache-2.0

# git-cliff configuration for automated changelog generation
# See: https://git-cliff.org/docs/configuration

[changelog]
# Template for the changelog header
header = """
# Changelog

All notable changes to CodeWeaver will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

"""
# Template for the changelog body
# Available variables:
# - version: Version number
# - message: Commit message
# - date: Commit date
# - commits: List of commits for this version
body = """
{% if version -%}
    ## [{{ version | trim_start_matches(pat="v") }}] - {{ timestamp | date(format="%Y-%m-%d") }}
{% else -%}
    ## [Unreleased]
{% endif -%}
{% for group, commits in commits | group_by(attribute="group") %}
    ### {{ group | striptags | trim | upper_first }}
    {%- for commit in commits -%}
        {%- if commit.message is starting_with("SQUASH | ") -%}
            {# Handle squash merge format: "SQUASH | description | #123" #}
            {%- set_global parts = commit.message | split(pat=" | ") -%}
            {%- set_global pr_desc = parts | nth(n=1) | trim -%}
            {%- set_global pr_num = parts | nth(n=2) | replace(from="#", to="") | trim -%}
            {%- if pr_num is matching("^[0-9]+$") -%}
    - {{ pr_desc }} ([#{{ pr_num }}](https://github.com/knitli/codeweaver/pull/{{ pr_num }}))
            {%- else -%}
    - {{ pr_desc }}
            {%- endif -%}
        {%- elif commit.message is starting_with("Merge pull request") -%}
            {# Handle regular merge format: "Merge pull request #123 from org/branch | Description" #}
            {%- set_global pr_num = commit.message | replace(from="Merge pull request #", to="") | split(pat=" ") | first | trim -%}
            {%- if commit.message is containing(" | ") -%}
                {%- set_global sep_index = commit.message | find(pat=" | ") -%}
                {%- if sep_index is not none and sep_index >= 0 -%}
                    {%- set_global pr_desc = commit.message | slice(start=(sep_index + 3)) | trim -%}
                {%- else -%}
                    {%- set_global pr_desc = "No description" -%}
                {%- endif -%}
            {%- endif %}
            {%- if pr_num is matching("^[0-9]+$") -%}
    - {{ pr_desc }} ([#{{ pr_num }}](https://github.com/knitli/codeweaver/pull/{{ pr_num }}))
            {%- else -%}
    - {{ pr_desc }}
            {%- endif -%}
        {%- else %}
    - {{ commit.message | upper_first }}
        {%- endif -%}
        {%- if commit.breaking %}
      - **BREAKING**: {{ commit.breaking_description }}
        {%- endif -%}
    {% endfor %}
{% endfor %}
"""
# Template for the changelog footer
footer = """
<!-- generated by git-cliff -->
"""
# Remove the leading and trailing whitespace from the templates
trim = true
# Postprocessors to apply after rendering the changelog
# postprocessors = [
#   # Replace issue/PR numbers with links
#   { pattern = '\(#([0-9]+)\)', replace = "([#${1}](https://github.com/knitli/codeweaver/pull/${1}))" },
# ]

[git]
# Parse commits based on https://www.conventionalcommits.org
conventional_commits = false
# Filter out commits that are not conventional
filter_unconventional = false
# Process merge commits - THIS IS KEY for PR-based changelog
split_commits = false
# Preprocessors for both merge commits and squash merges
commit_preprocessors = [
  # 1. Extract PR description from merge commits and append to subject
  # Input: "Merge pull request #123 from org/branch\n\nPR Description"
  # Output: "Merge pull request #123 from org/branch | PR Description"
  { pattern = 'Merge pull request (#[0-9]+) from ([^\n]+)\n+([\s\S]+)', replace = "Merge pull request ${1} from ${2} | ${3}" },

  # 2. Mark squash merge commits for easier template detection
  # Input: "feat: some feature (#123)"
  # Output: "SQUASH | feat: some feature | #123"
  { pattern = '^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+?\))?: (.+) \(#([0-9]+)\)$', replace = "SQUASH | ${1}${2}: ${3} | #${4}" },

  # 3. Catch squash merges without conventional commit prefix
  # Input: "Some change (#123)"
  # Output: "SQUASH | Some change | #123"
  { pattern = '^(.+) \(#([0-9]+)\)$', replace = "SQUASH | ${1} | #${2}" },
]
# Parse both merge commits and squash merges to extract PR info
# NOTE: Order matters! Commits are matched top-to-bottom, first match wins
commit_parsers = [
  # Skip non-PR merge commits (like "Merge branch 'main'")
  { message = "^Merge branch", skip = true },

  # === Squash Merge Parsers (conventional commits) ===
  # After preprocessing, squash merges are in format: "SQUASH | type: description | #123"
  { message = "^SQUASH \\| feat", group = "Features" },
  { message = "^SQUASH \\| fix", group = "Bug Fixes" },
  { message = "^SQUASH \\| docs", group = "Documentation" },
  { message = "^SQUASH \\| perf", group = "Performance" },
  { message = "^SQUASH \\| refactor", group = "Refactoring" },
  { message = "^SQUASH \\| test", group = "Testing" },
  { message = "^SQUASH \\| build", group = "Build System" },
  { message = "^SQUASH \\| ci", group = "CI/CD" },
  { message = "^SQUASH \\| chore", group = "Maintenance" },
  { message = "^SQUASH \\| revert", group = "Reverts" },
  { message = "^SQUASH \\|", group = "Other Changes" },

  # === Regular Merge Commit Parsers (branch-based) ===
  # Features - check branch name patterns
  { message = "^Merge pull request #[0-9]+ from .*/feat", group = "Features" },
  { message = "^Merge pull request #[0-9]+ from .*/feature", group = "Features" },
  # Fixes - multiple patterns for fix-related branches
  { message = "^Merge pull request #[0-9]+ from .*/fix", group = "Bug Fixes" },
  { message = "^Merge pull request #[0-9]+ from .*/bugfix", group = "Bug Fixes" },
  { message = "^Merge pull request #[0-9]+ from .*/hotfix", group = "Bug Fixes" },
  { message = "^Merge pull request #[0-9]+ from .*/issue-", group = "Bug Fixes" },
  # Documentation
  { message = "^Merge pull request #[0-9]+ from .*/docs", group = "Documentation" },
  { message = "^Merge pull request #[0-9]+ from .*/doc", group = "Documentation" },
  # Performance
  { message = "^Merge pull request #[0-9]+ from .*/perf", group = "Performance" },
  { message = "^Merge pull request #[0-9]+ from .*/optimize", group = "Performance" },
  # Refactoring
  { message = "^Merge pull request #[0-9]+ from .*/refactor", group = "Refactoring" },
  # Testing
  { message = "^Merge pull request #[0-9]+ from .*/test", group = "Testing" },
  # CI/CD and tooling
  { message = "^Merge pull request #[0-9]+ from .*/ci", group = "CI/CD" },
  { message = "^Merge pull request #[0-9]+ from .*/workflow", group = "CI/CD" },
  { message = "^Merge pull request #[0-9]+ from .*/build", group = "Build System" },
  # Chores and maintenance
  { message = "^Merge pull request #[0-9]+ from .*/chore", group = "Maintenance" },
  # Catch-all for other PRs (will be categorized as miscellaneous)
  { message = "^Merge pull request #[0-9]+", group = "Other Changes" },
]
# Protect breaking changes from being skipped due to matching a skipping commit_parser
protect_breaking_commits = false
# Filter commits - when true, only commits matching a non-skip parser are included
filter_commits = true
# Regex for tags to include in the changelog
tag_pattern = "v[0-9]+\\.[0-9]+\\.[0-9]+.*"
# Skip tags matching this regex
skip_tags = ""
# Ignore tags matching this regex
ignore_tags = ""
# Sort tags chronologically
date_order = false
# Sort commits inside sections by oldest/newest order
sort_commits = "newest"
# Limit the number of commits included in the changelog
# limit_commits = 42
