# SPDX-FileCopyrightText: 2025 Knitli Inc.
# SPDX-FileContributor: Adam Poulemanos <adam@knit.li>
#
# SPDX-License-Identifier: MIT OR Apache-2.0

# git-cliff configuration for automated changelog generation
# See: https://git-cliff.org/docs/configuration

[changelog]
# Template for the changelog header
header = """
# Changelog

All notable changes to CodeWeaver will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

"""
# Template for the changelog body
# Available variables:
# - version: Version number
# - message: Commit message
# - date: Commit date
# - commits: List of commits for this version
body = """
{% if version -%}
    ## [{{ version | trim_start_matches(pat="v") }}] - {{ timestamp | date(format="%Y-%m-%d") }}
{% else -%}
    ## [Unreleased]
{% endif -%}
{% for group, commits in commits | group_by(attribute="group") %}
    ### {{ group | striptags | trim | upper_first }}
    {%- for commit in commits -%}
        {%- if commit.message is starting_with("Merge pull request") -%}
            {%- set_global pr_num = commit.message | replace(from="Merge pull request #", to="") | split(pat=" ") | first -%}
            {%- if commit.message is containing(" | ") -%}
                {%- set_global pr_desc = commit.message | split(pat=" | ") | last -%}
            {%- else -%}
                {%- set_global pr_desc = "No description" -%}
            {%- endif %}
    - {{ pr_desc }} ([#{{ pr_num }}](https://github.com/knitli/codeweaver/pull/{{ pr_num }}))
        {%- else %}
    - {{ commit.message | upper_first }}
        {%- endif -%}
        {%- if commit.breaking %}
      - **BREAKING**: {{ commit.breaking_description }}
        {%- endif -%}
    {% endfor %}
{% endfor %}
"""
# Template for the changelog footer
footer = """
<!-- generated by git-cliff -->
"""
# Remove the leading and trailing whitespace from the templates
trim = true
# Postprocessors to apply after rendering the changelog
postprocessors = [
  # Replace issue/PR numbers with links
  { pattern = '\(#([0-9]+)\)', replace = "([#${1}](https://github.com/knitli/codeweaver/pull/${1}))" },
]

[git]
# Parse commits based on https://www.conventionalcommits.org
conventional_commits = false
# Filter out commits that are not conventional
filter_unconventional = false
# Process merge commits - THIS IS KEY for PR-based changelog
split_commits = false
# Only include merge commits (PR merges)
# Preprocessor to append PR description to the merge commit message for easier extraction
commit_preprocessors = [
  # Extract PR description and append to subject for template use
  # Input: "Merge pull request #123 from org/branch\n\nPR Description"
  # Output: "Merge pull request #123 from org/branch | PR Description"
  { pattern = 'Merge pull request (#[0-9]+) from ([^\n]+)\n+(.+)', replace = "Merge pull request ${1} from ${2} | ${3}" },
]
# Parse merge commits to extract PR info
# NOTE: Order matters! Commits are matched top-to-bottom, first match wins
commit_parsers = [
  # Skip non-PR merge commits (like "Merge branch 'main'")
  { message = "^Merge branch", skip = true },
  # Features - check branch name patterns
  { message = "^Merge pull request #[0-9]+ from .*/feat", group = "Features" },
  { message = "^Merge pull request #[0-9]+ from .*/feature", group = "Features" },
  # Fixes - multiple patterns for fix-related branches
  { message = "^Merge pull request #[0-9]+ from .*/fix", group = "Bug Fixes" },
  { message = "^Merge pull request #[0-9]+ from .*/bugfix", group = "Bug Fixes" },
  { message = "^Merge pull request #[0-9]+ from .*/hotfix", group = "Bug Fixes" },
  { message = "^Merge pull request #[0-9]+ from .*/issue-", group = "Bug Fixes" },
  # Documentation
  { message = "^Merge pull request #[0-9]+ from .*/docs", group = "Documentation" },
  { message = "^Merge pull request #[0-9]+ from .*/doc", group = "Documentation" },
  # Performance
  { message = "^Merge pull request #[0-9]+ from .*/perf", group = "Performance" },
  { message = "^Merge pull request #[0-9]+ from .*/optimize", group = "Performance" },
  # Refactoring
  { message = "^Merge pull request #[0-9]+ from .*/refactor", group = "Refactoring" },
  # Testing
  { message = "^Merge pull request #[0-9]+ from .*/test", group = "Testing" },
  # CI/CD and tooling
  { message = "^Merge pull request #[0-9]+ from .*/ci", group = "CI/CD" },
  { message = "^Merge pull request #[0-9]+ from .*/workflow", group = "CI/CD" },
  { message = "^Merge pull request #[0-9]+ from .*/build", group = "Build System" },
  # Chores and maintenance
  { message = "^Merge pull request #[0-9]+ from .*/chore", group = "Maintenance" },
  # Catch-all for other PRs (will be categorized as miscellaneous)
  { message = "^Merge pull request #[0-9]+", group = "Other Changes" },
]
# Protect breaking changes from being skipped due to matching a skipping commit_parser
protect_breaking_commits = false
# Filter commits - when true, only commits matching a non-skip parser are included
filter_commits = true
# Regex for tags to include in the changelog
tag_pattern = "v[0-9].*"
# Skip tags matching this regex
skip_tags = ""
# Ignore tags matching this regex
ignore_tags = ""
# Sort tags chronologically
date_order = false
# Sort commits inside sections by oldest/newest order
sort_commits = "newest"
# Limit the number of commits included in the changelog
# limit_commits = 42
