# SPDX-FileCopyrightText: 2025 Knitli Inc.
# SPDX-License-Identifier: MIT OR Apache-2.0
#
# GitHub Actions workflow to automatically submit CodeWeaver to the MCP Registry
# Triggers on release publication after PyPI package is available

name: Submit to MCP Registry

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to submit (leave empty to use latest release)"
        required: false
        type: string

permissions:
  contents: read

jobs:
  validate-and-submit:
    name: Validate and Submit to MCP Registry
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@b3498302c5c423fa896b97a26bb183df735d08f8
        with:
          ref: ${{ github.event.release.tag_name || github.ref }}
          fetch-depth: 1

      - name: Install uv
        uses: ./.github/actions/setup-uv-env
        with:
          python-version: "3.12"
          github-token: ${{ secrets.GITHUB_TOKEN }}
        id: uv-setup
      - name: Extract version information
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          elif [ -n "${{ github.event.release.tag_name }}" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            # Remove 'v' prefix if present
            VERSION="${VERSION#v}"
          else
            # Fallback to reading from _version.py
            VERSION=$(grep -oP "__version__: Final\[str\] = \"\K[^\"]+" "src/codeweaver/_version.py")
          fi

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Detected version: ${VERSION}"

      - name: Regenerate server.json from code
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Regenerating server.json from code with version ${VERSION}..."

          # Run the generation script (uses PEP 723 dependencies)
          uv run scripts/build/generate-mcp-server-json.py
          echo "✓ server.json regenerated"

      - name: Wait for PyPI package availability
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          MAX_ATTEMPTS=30
          SLEEP_TIME=60

          echo "Waiting for codeweaver ${VERSION} to be available on PyPI..."
          echo "This may take up to 30 minutes after release publication"

          # Install packaging library for version normalization
          pip install packaging

          # Normalize version to PEP 440 format (e.g., 0.1.0alpha.1 -> 0.1.0a1)
          NORMALIZED_VERSION="$(python -c "
          from packaging.version import Version
          import sys
          try:
              v = Version('${VERSION}')
              print(str(v))
          except Exception as e:
              print('${VERSION}', file=sys.stderr)
              sys.exit(1)
          ")"

          echo "Original version: ${VERSION}"
          echo "Normalized version for PyPI: ${NORMALIZED_VERSION}"

          for i in $(seq 1 "$MAX_ATTEMPTS"); do
            echo "Attempt $i/$MAX_ATTEMPTS..."

            # Check if package version exists on PyPI using normalized version
            HTTP_CODE="$(curl -s -o /dev/null -w "%{http_code}" \
              "https://pypi.org/pypi/code-weaver/${NORMALIZED_VERSION}/json")"

            if [ "$HTTP_CODE" = "200" ]; then
              echo "✓ Package code-weaver ${NORMALIZED_VERSION} is available on PyPI"
              exit 0
            fi

            if [ "$i" -lt "$MAX_ATTEMPTS" ]; then
              echo "Package not yet available (HTTP ${HTTP_CODE}), waiting ${SLEEP_TIME}s..."
              sleep "$SLEEP_TIME"
            fi
          done

          echo "ERROR: Package not available on PyPI after ${MAX_ATTEMPTS} attempts"
          echo "Please verify that the package was successfully published"
          exit 1

      - name: Install mcp-publisher CLI
        env:
          MCP_PUBLISHER_VERSION: "v1.3.10"
        run: |
          ARCH="$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/')"
          OS="$(uname -s | tr '[:upper:]' '[:lower:]')"
          VERSION="${MCP_PUBLISHER_VERSION:- v1.3.10}"
          # TODO: I don't know why we're doing all this to get and use the CLI when we could use the api directly
          echo "Downloading mcp-publisher ${VERSION} for ${OS}/${ARCH}..."
          assets="$(curl -L \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer <YOUR-TOKEN>" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/repos/OWNER/REPO/releases/latest)"
          our_index="$(echo "$assets" | jq -r '.assets[].name' | grep -n "^mcp-publisher_${OS}_${ARCH}.tar.gz$" | cut -d: -f1)"
          asset="$(echo "$assets" | jq -r ".assets[$((our_index - 1))]")"
          download_url="$(echo "$asset" | jq -r '.browser_download_url')"
          digest="$(echo "$asset" | jq -r '.digest' | cut -d: -f2)"
          curl -L -o mcp-publisher.tar.gz "$download_url"
          downloaded_digest="$(sha256sum mcp-publisher.tar.gz | awk '{print $1}')"
          if [ "$digest" != "$downloaded_digest" ]; then
            echo "ERROR: Checksum verification failed for mcp-publisher"
            echo "Expected: $digest"
            echo "Got:      $downloaded_digest"
            exit 1
          fi
          tar xz < mcp-publisher.tar.gz mcp-publisher
          sudo mv mcp-publisher /usr/local/bin/
          chmod +x /usr/local/bin/mcp-publisher
          rm mcp-publisher.tar.gz

          echo "✓ mcp-publisher installed"
          mcp-publisher --version || echo "Version check not available"

      - name: Submit to MCP Registry
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MCP_REGISTRY_KEY: ${{ secrets.MCP_REGISTRY_KEY }}
        run: |
          echo "Submitting to MCP Registry..."

          # we need to login with our domain key first
          # the request has three fields: domain (knitli.com), signed_timestamp (hex encoded signature), timestamp (RFC3339)
          # we need to sign the timestamp with the private key, which is in MCP_REGISTRY_KEY
          # MCP_REGISTRY_KEY is expected to be in PEM format, and it uses ed25519 algorithm
          # unfortunately, pkeyutl can only work with files because of how it has to buffer the input for signing

          domain="knitli.com"
          indata="$(mktemp)"
          echo -n "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" > "$indata"

          key_file="$(mktemp)"
          echo "$MCP_REGISTRY_KEY" > "$key_file"
          chmod 600 "$key_file"
          outfile="$(mktemp)"

          openssl pkeyutl -sign -inkey "$key_file" -out "$outfile" -rawin  -in "$indata"
          signed_timestamp_hex="$(xxd -p "$outfile" | tr -d '\n')"
          request_body="$(mktemp)"
          {
            echo -n '{"domain":"'"$domain"'",'
            echo -n '"signed_timestamp":"'"$signed_timestamp_hex"'",'
            echo -n '"timestamp":"'"$(cat "$indata")"'"}'
          } > "$request_body"
          echo "Logging in to MCP Registry..."
          response="$(curl --request POST \
            --url "https://registry.modelcontextprotocol.io/v0.1/auth/dns" \
            --header "Accept: application/json, application/problem+json" \
            --header "Content-Type: application/json" \
            --data @"$request_body")"
          token="$(echo "$response" | jq -r '.registry_token')"
          rm "$indata" "$key_file" "$outfile"
          rm "$request_body"
          if [ -z "$token" ] || [ "$token" = "null" ]; then
            echo "ERROR: Failed to obtain registry token"
            echo "Response: $response"
            exit 1
          fi
          echo "✓ Obtained registry token"
          export MCP_LOGIN_TOKEN="$token"
          publication_response="$(curl --request POST \
          --url https://registry.modelcontextprotocol.io/v0.1/publish \
          --header 'Accept: application/json, application/problem+json' \
          --header "Authorization: Bearer $MCP_LOGIN_TOKEN" \
          --header 'Content-Type: application/json' \
          --data @./server.json)"
          echo "Publication response: $publication_response"
          publication_time="$(echo "$publication_response" | jq -r '._meta."io.modelcontextprotocol.registry/official".published_at')"
          if [ -z "$publication_time" ] || [ "$publication_time" = "null" ]; then
            echo "ERROR: Submission to MCP Registry failed"
            exit 1
          fi
          echo "✓ Successfully submitted to MCP Registry at $publication_time"
          export MCP_PUBLICATION_TIME="$publication_time"
          exit 0

      - name: Summary of MCP Registry Submission
        if: always()
        run: |
          {
            echo "## MCP Registry Submission Summary"
            echo ""
            echo "- **Version**: ${{ steps.version.outputs.version }}"
            echo "- **Status**: ${{ job.status }}"
            if [ -n "$MCP_PUBLICATION_TIME" ]; then
              echo "- **Published At**: $MCP_PUBLICATION_TIME"
            fi
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

          if [ "${{ job.status }}" = "success" ]; then
            {
              echo "✅ Successfully submitted to MCP Registry"
              echo ""
              echo "View your server at: https://registry.modelcontextprotocol.io/v0.1/servers/com.knitli%2Fcodeweaver/versions/${{ steps.version.outputs.version }}"
            } >> "$GITHUB_STEP_SUMMARY"
          else
            {
              echo "❌ Submission failed"
              echo ""
              echo "Please check the workflow logs for details."
            } >> "$GITHUB_STEP_SUMMARY"
          fi
