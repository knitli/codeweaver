# SPDX-FileCopyrightText: 2025 Knitli Inc.
# SPDX-FileContributor: Adam Poulemanos <adam@knit.li>
#
# SPDX-License-Identifier: MIT OR Apache-2.0

name: Publish to TestPyPI
on:
  workflow_dispatch:
    inputs:
      run_tests:
        description: Run tests before publishing
        required: false
        default: true
        type: boolean
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false
jobs:
  tests:
    name: Run Tests
    if: ${{ github.event.inputs.run_tests == 'true' }}
    uses: ./.github/workflows/_reusable-test.yml
    with:
      python-versions: '["3.12", "3.13"]'
      test-markers: 'not docker and not qdrant and not dev_only and not skip_ci'
      upload-coverage: false
      run-quality-checks: true
    secrets: inherit

  build:
    name: Build Distribution
    needs: tests
    if: always() && (needs.tests.result == 'success' || needs.tests.result == 'skipped')
    uses: ./.github/workflows/_reusable-build.yml
    with:
      artifact-name: python-package-distributions
      python-version: "3.12"
      upload-artifacts: true
      clean-build: true

  publish-to-testpypi:
    name: Publish to TestPyPI
    needs:
      - build
    runs-on: ubuntu-latest
    environment:
      name: testpypi
      url: https://test.pypi.org/p/codeweaver
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0
        with:
          name: python-package-distributions
          path: dist/
      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e
        with:
          repository-url: https://test.pypi.org/legacy/
          attestations: true
