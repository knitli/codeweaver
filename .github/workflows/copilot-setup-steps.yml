# SPDX-FileCopyrightText: 2025 Knitli Inc.
# SPDX-FileContributor: Adam Poulemanos <adam@knit.li>
#
# SPDX-License-Identifier: MIT OR Apache-2.0

name: Copilot Setup Steps
# Automatically run the setup steps when they are changed to allow for easy validation, and
# allow manual testing through the repository's "Actions" tab
on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml
jobs:
  # The job MUST be called `copilot-setup-steps` or it will not be picked up by Copilot.
  copilot-setup-steps:
    env:
      CODEWEAVER_VECTOR_STORE_URL: ${{ secrets.CODEWEAVER_VECTOR_STORE_URL }}
      QDRANT__SERVICE__API_KEY: ${{ secrets.QDRANT__SERVICE__API_KEY }}
      VOYAGE_API_KEY: ${{ secrets.VOYAGE_API_KEY }}
      CODEWEAVER_PROJECT_PATH: ${{ github.workspace }}
      MISE_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      MISE_YES: 1
      # Limit CodeQL memory usage to prevent OOM kills on standard runners (7GB total RAM)
      # Note: Standard runners have ~7GB, so limit to 3GB to leave headroom for system
      CODEQL_RAM: 3072
      CODEQL_THREADS: 2
      # Additional limits for CodeQL extractor and evaluator
      CODEQL_EXTRACTOR_PYTHON_RAM: 2048
      CODEQL_EVALUATOR_RAM: 2048
    runs-on: ubuntu-latest
    # Alternative: Use ubuntu-latest-4-cores (16GB RAM) if OOM issues persist
    # Requires GitHub Team/Enterprise plan
    # runs-on: ubuntu-latest-4-cores
    # Add an overall job timeout so we don't let runaway installs exhaust the runner indefinitely
    timeout-minutes: 50
    # Set the permissions to the lowest permissions possible needed for your steps.
    # Copilot will be given its own token for its operations.
    permissions:
      # If you want to clone the repository as part of your setup steps, for example to install dependencies, you'll need the `contents: read` permission.
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 2
      - name: Free up disk space
        run: ./scripts/dev-env/ci-free-disk-space.sh
      - name: Setup Mise Environment
        uses: ./.github/actions/setup-mise-env
        with:
          python-version: "3.13"
          github-token: ${{ secrets.GITHUB_TOKEN }}
          profile: "dev"
          skip-checkout: "true"
      - name: Make scripts executable
        run: |
          chmod -R +x scripts
          chmod -R +x mise-tasks
