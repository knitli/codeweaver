# SPDX-FileCopyrightText: 2025 Knitli Inc.
# SPDX-FileContributor: Adam Poulemanos <adam@knit.li>
#
# SPDX-License-Identifier: MIT OR Apache-2.0

name: Release
on:
  push:
    branches:
      - main
      - staging
    tags:
      - v*
  workflow_dispatch:
    inputs:
      tag:
        description: Tag to release
        required: true
        type: string
  release:
    types:
      - published
permissions:
  contents: write
  packages: write
  discussions: write
  actions: read
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false
jobs:
  tests:
    name: Run Tests
    # EFFICIENCY: Skip tests on tag push (rely on PR tests), but allow manual trigger
    # TODO: Add smoke tests for releases
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'release'
    uses: ./.github/workflows/_reusable-test.yml
    with:
      python-versions: '["3.12", "3.13", "3.14"]'
      test-markers: not docker and not qdrant and not dev_only and not skip_ci and not network and not external_api and not flaky
      upload-coverage: false
      run-quality-checks: true
    secrets: inherit
  build:
    name: Build Distribution
    needs: tests
    if: always() && (needs.tests.result == 'success' || needs.tests.result == 'skipped')
    uses: ./.github/workflows/_reusable-build.yml
    with:
      artifact-name: python-package-distributions
      python-version: "3.12"
      upload-artifacts: true
      clean-build: true
    secrets: inherit
  github-release:
    name: Create GitHub Release
    needs:
      - build
    if: always() && needs.build.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      discussions: write
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0
      - name: Download artifacts
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0
        with:
          name: python-package-distributions
          path: dist/
      - name: Extract version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.tag }}"
            VERSION="${VERSION#v}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=v$VERSION" >> "$GITHUB_OUTPUT"
      - name: Install git-cliff
        uses: taiki-e/install-action@331a600f1b10a3fed8dc56f925012bede91ae51f
        with:
          tool: git-cliff@2.10.0
      - name: Generate release notes
        id: release_notes
        run: "# Get the latest release tag (before current)\nPREVIOUS_TAG=\"$(git tag --sort=-version:refname | grep -E '^v[0-9]+\\.[0-9]+\\.[0-9]+([ab]|rc|-alpha|-beta)?[0-9]*(\\.[0-9]+)?$' | head -2 | tail -1 || echo \"\")\"\nCURRENT_TAG=\"${{ steps.version.outputs.tag }}\"\nVERSION=\"${{ steps.version.outputs.version }}\"\n\necho \"Previous tag: $PREVIOUS_TAG\"\necho \"Current tag: $CURRENT_TAG\"\n\n# Generate changelog using git-cliff.\n# Note: We use '--strip header' to intentionally remove the changelog header (as defined in cliff.toml),\n# so that only the changes section is extracted for embedding in the release notes.\nif [ -n \"$PREVIOUS_TAG\" ] && [ \"$PREVIOUS_TAG\" != \"$CURRENT_TAG\" ]; then\n  # Generate changelog for the range between previous and current tag\n  git-cliff --strip header --tag \"$CURRENT_TAG\" \"$PREVIOUS_TAG..$CURRENT_TAG\" > changelog_section.md\nelse\n  # First release - get all commits\n  git-cliff --strip header --tag \"$CURRENT_TAG\" > changelog_section.md\nfi\n\n# Build complete release notes with installation instructions\ncat > release_notes.md << 'EOF'\n## What's Changed\n\nEOF\n\ncat changelog_section.md >> release_notes.md\n\ncat >> release_notes.md << 'EOF'\n\n## Installation\n\nEOF\n\n# Add pre-release specific installation instructions\nif [[ \"$VERSION\" == *\"a\"* ]] || [[ \"$VERSION\" == *\"b\"* ]] || [[ \"$VERSION\" == *\"rc\"* ]]; then\n  cat >> release_notes.md << EOF\n**This is a pre-release version.** Install with:\n\\`\\`\\`bash\npip install --pre code-weaver\n# Or specific version:\npip install code-weaver==$VERSION\n\\`\\`\\`\nEOF\nelse\n  cat >> release_notes.md << 'EOF'\nInstall from PyPI:\n```bash\npip install code-weaver\n```\nEOF\nfi\n\ncat >> release_notes.md << 'EOF'\n\nOr download the wheel/source distribution from the assets below.\n\n## Verification\n\nAll release artifacts are built from source and include:\n- \U0001F4E6 Wheel distribution (.whl)\n- \U0001F4E6 Source distribution (.tar.gz)\n\nEOF\n\nif [ -n \"$PREVIOUS_TAG\" ]; then\n  echo \"**Full Changelog**: https://github.com/knitli/codeweaver/compare/$PREVIOUS_TAG...$CURRENT_TAG\" >> release_notes.md\nelse\n  echo \"**Full Changelog**: https://github.com/knitli/codeweaver/commits/$CURRENT_TAG\" >> release_notes.md\nfi\n"
      - name: Create GitHub Release
        uses: softprops/action-gh-release@5be0e66d93ac7ed76da52eca8bb058f665c3a5fe
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: CodeWeaver ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          files: |
            dist/*.whl
            dist/*.tar.gz
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'a') || contains(steps.version.outputs.version, 'b') || contains(steps.version.outputs.version, 'rc') }}
          generate_release_notes: false
  publish-to-pypi:
    name: Publish to PyPI
    needs:
      - tests
      - build
      - github-release
    if: always() && (needs.tests.result == 'success' || needs.tests.result == 'skipped') && needs.build.result == 'success' && needs.github-release.result == 'success'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://pypi.org/p/codeweaver
    permissions:
      id-token: write
      contents: read
      packages: read
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0
        with:
          name: python-package-distributions
          path: dist/
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e
        with:
          repository-url: https://upload.pypi.org/legacy/
          attestations: true
