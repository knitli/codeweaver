# SPDX-FileCopyrightText: 2025 Knitli Inc.
# SPDX-FileContributor: Adam Poulemanos <adam@knit.li>
#
# SPDX-License-Identifier: MIT OR Apache-2.0

name: Release
on:
  push:
    tags:
      - v*
  workflow_dispatch:
    inputs:
      tag:
        description: Tag to release
        required: true
        type: string
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false
jobs:
  tests:
    name: Run Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version:
          - "3.12"
          - "3.13"
          - "3.14"
    steps:
      - name: Checkout code
        uses: actions/checkout@b3498302c5c423fa896b97a26bb183df735d08f8
        with:
          fetch-depth: 0
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@9b03c627221f32cb88b299427119da30671cf9cc
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y zsh
      - name: Cache mise tools
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        with:
          path: |
            ~/.local/share/mise
            ~/.local/bin/mise
            ~/.local/share/mise/shims
            ~/.cache/mise
            ~/.local/bin
          key: mise-${{ runner.os }}-${{ hashFiles('mise.toml') }}
          restore-keys: |
            mise-${{ runner.os }}-
      - name: Cache UV dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        with:
          path: |
            ~/.cache/uv
            .venv
          key: uv-${{ runner.os }}-python${{ matrix.python-version }}-${{ hashFiles('uv.lock') }}
          restore-keys: |
            uv-${{ runner.os }}-python${{ matrix.python-version }}-
            uv-${{ runner.os }}-
      - name: Install mise
        run: |
          if [ ! -f "$HOME/.local/bin/mise" ]; then
            curl https://mise.run | sh
            echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          fi
      - name: Install tools with mise
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          mise run setup > /dev/null 2>&1 || true
      - name: Run quality checks
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          mise run check
        continue-on-error: true # Allow reuse lint failures to be warnings
      - name: Run tests with coverage
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          mise run test-cov
  build:
    name: Build Distribution
    needs: tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@9b03c627221f32cb88b299427119da30671cf9cc
        with:
          python-version: "3.12"
      - name: Cache UV dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        with:
          path: |
            ~/.cache/uv
            .venv
          key: uv-release-${{ runner.os }}-${{ hashFiles('uv.lock') }}
          restore-keys: |
            uv-release-${{ runner.os }}-
            uv-${{ runner.os }}-
      - name: Install UV and build tools
        run: |
          python -m pip install uv twine
      - name: Build package
        run: |
          uv build --clean
      - name: Verify build artifacts
        run: "ls -la dist/\necho \"Built packages:\"\nfor file in dist/*; do\n  echo \"\U0001F4E6 $(basename \"$file\")\"\ndone\n"
      - name: Check package integrity with twine
        run: |
          uv pip install twine
          twine check dist/*
      - name: Upload artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: python-package-distributions
          path: dist/
  github-release:
    name: Create GitHub Release
    needs:
      - build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      discussions: write
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0
      - name: Download artifacts
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0
        with:
          name: python-package-distributions
          path: dist/
      - name: Extract version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.tag }}"
            VERSION="${VERSION#v}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=v$VERSION" >> "$GITHUB_OUTPUT"
      - name: Generate release notes
        id: release_notes
        run: |
          # Get the latest release tag (before current)
          PREVIOUS_TAG="$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+' | head -2 | tail -1 || echo "")"
          CURRENT_TAG="${{ steps.version.outputs.tag }}"

          echo "Previous tag: $PREVIOUS_TAG"
          echo "Current tag: $CURRENT_TAG"

          # Generate changelog
          cat > release_notes.md << 'EOF'
          ## What's Changed

          EOF

          if [ -n "$PREVIOUS_TAG" ] && [ "$PREVIOUS_TAG" != "$CURRENT_TAG" ]; then
            # Get commits since last release
            git log --pretty=format:"- %s (%h)" --no-merges "$PREVIOUS_TAG..$CURRENT_TAG" >> release_notes.md
          else
            echo "- Initial alpha release" >> release_notes.md
          fi

          cat >> release_notes.md << 'EOF'

          ## Installation

          EOF

          # Add pre-release specific installation instructions
          VERSION="${{ steps.version.outputs.version }}"
          if [[ "$VERSION" == *"a"* ]] || [[ "$VERSION" == *"b"* ]] || [[ "$VERSION" == *"rc"* ]]; then
            cat >> release_notes.md << 'EOF'
          **This is a pre-release version.** Install with:
          ```bash
          pip install --pre codeweaver-mcp
          # Or specific version:
          pip install codeweaver-mcp==${{ steps.version.outputs.version }}
          ```
          EOF
          else
            cat >> release_notes.md << 'EOF'
          Install from PyPI:
          ```bash
          pip install codeweaver-mcp
          ```
          EOF
          fi

          cat >> release_notes.md << 'EOF'

          Or download the wheel/source distribution from the assets below.

          ## Verification

          All release artifacts are built from source and include:
          - ðŸ“¦ Wheel distribution (.whl)
          - ðŸ“¦ Source distribution (.tar.gz)

          EOF

          if [ -n "$PREVIOUS_TAG" ]; then
            echo "**Full Changelog**: https://github.com/knitli/codeweaver-mcp/compare/$PREVIOUS_TAG...$CURRENT_TAG" >> release_notes.md
          else
            echo "**Full Changelog**: https://github.com/knitli/codeweaver-mcp/commits/$CURRENT_TAG" >> release_notes.md
          fi
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: CodeWeaver ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          files: |
            dist/*.whl
            dist/*.tar.gz
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'a') || contains(steps.version.outputs.version, 'b') || contains(steps.version.outputs.version, 'rc') }}
          generate_release_notes: false

  publish-to-pypi:
    name: Publish to PyPI
    needs: [tests, build, github-release]
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://pypi.org/p/codeweaver-mcp
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0
        with:
          name: python-package-distributions
          path: dist/
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://upload.pypi.org/legacy/
          attestations: true
