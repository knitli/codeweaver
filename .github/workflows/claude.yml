# SPDX-FileCopyrightText: 2025 Knitli Inc.
# SPDX-FileContributor: Adam Poulemanos <adam@knit.li>
#
# SPDX-License-Identifier: MIT OR Apache-2.0

name: Claude Assistant
on:
  issue_comment:
    types:
      - created
  pull_request_review_comment:
    types:
      - created
  issues:
    types:
      - opened
      - assigned
      - labeled
  pull_request_review:
    types:
      - submitted
permissions:
  actions: read
  checks: read
  issues: write
  contents: write
  discussions: write
  pull-requests: write
jobs:
  claude-response:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      QDRANT__SERVICE__API_KEY: ${{ secrets.QDRANT__SERVICE__API_KEY }}
      VOYAGE_API_KEY: ${{ secrets.VOYAGE_API_KEY }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 2
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: PR Review
        if: github.event_name == 'pull_request_review'
        uses: anthropics/claude-code-action@e8bad572273ce919ba15fec95aef0ce974464753
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          trigger_phrase: '@claude'
          assignee_trigger: claude
          label_trigger: claude
          base_branch: main
          use_commit_signing: true
          claude_args: |
            --max-turns 30
            --allowedTools Bash,Batch,Glob,Grep,ToDoWrite,View,mcp__context7__get-library-docs,mcp__context7__resolve-library-id,mcp__sequential-thinking__sequentialthinking
            --mcp-config .mcp.json
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Please review this pull request and identify:
              - bugs
              - security issues and potential vulnerabilities
              - performance issues
            If you identify issues, briefly describe them. Provide a recommended fix with example implementation.

            Keep your feedback focused, actionable, and concise.
      - name: Issue Opened
        if: github.event_name == 'issues' && github.event.action == 'opened'
        uses: anthropics/claude-code-action@e8bad572273ce919ba15fec95aef0ce974464753
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          trigger_phrase: '@claude'
          assignee_trigger: claude
          label_trigger: claude
          track_progress: true
          use_commit_signing: true
          base_branch: main
          claude_args: |
            --max-turns 30
            --allowedTools Bash,Batch,Glob,Grep,ToDoWrite,View,mcp__context7__get-library-docs,mcp__context7__resolve-library-id,mcp__sequential-thinking__sequentialthinking
            --mcp-config .mcp.json
          prompt: |
            REPO: ${{ github.repository }}
            ISSUE NUMBER: ${{ github.event.issue.number }}
            When a new issue is opened:
              - Review and summarize the issue.
              - Include any relevant context or background.
              - Look for related issues or discussions and link to them.
              - Assign relevant labels, or if you can't assign them, suggest them.
              - If the issue covers the same topic as an existing open or closed issue, recommend closing the issue and linking to the relevant PR or issue.
              - Identify potential fixes and briefly describe them with links to relevant code.
              - If it's a feature request, estimate the difficulty of implementing the feature and potential impact on existing functionality and API.
      - name: PR Review Comment
        if: github.event_name == 'pull_request_review_comment'
        uses: anthropics/claude-code-action@e8bad572273ce919ba15fec95aef0ce974464753
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          trigger_phrase: '@claude'
          assignee_trigger: claude
          label_trigger: claude
          use_commit_signing: true
          base_branch: main
          claude_args: |
            --max-turns 30
            --allowedTools Bash,Batch,Glob,Grep,ToDoWrite,View,mcp__context7__get-library-docs,mcp__context7__resolve-library-id,mcp__sequential-thinking__sequentialthinking
            --mcp-config .mcp.json
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}
            COMMENT ID: ${{ github.event.comment.id }}
            When you are asked to review a pull request:
              - Review the changes made in the PR.
              - Provide feedback on the code quality, functionality, and adherence to best practices.
              - Consider the library's existing code style and whether the code aligns with it.
              - Consider possible security or performance effects.
              - Suggest improvements or alternatives where applicable.
              - If the changes are satisfactory and the code passes checks, approve the PR with a comment.
      - name: Issue Assigned or Labeled Claude
        if: |
          (github.event_name == 'issues' && github.event.action == 'assigned') || (github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'claude')
        uses: anthropics/claude-code-action@e8bad572273ce919ba15fec95aef0ce974464753
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          trigger_phrase: '@claude'
          assignee_trigger: claude
          label_trigger: claude
          track_progress: true
          use_commit_signing: true
          base_branch: main
          claude_args: |
            --max-turns 30
            --allowedTools Bash,Batch,Glob,Grep,ToDoWrite,View,mcp__context7__get-library-docs,mcp__context7__resolve-library-id,mcp__sequential-thinking__sequentialthinking,mcp__github_ci__get_workflow_run_details
            --mcp-config .mcp.json
          prompt: |
            REPO: ${{ github.repository }}
            ISSUE NUMBER: ${{ github.event.issue.number }}
            When you are assigned an issue or it's labeled 'claude':
              - Your job is to resolve it.
              - Gather all necessary information about the issue from discussions and comments and the codebase.
              - If the issue involves external libraries, use the context7 tool to get the latest information on the API.
              - Communicate with the issue reporter for clarification if needed.
              - Create an issue branch.
              - Develop a detailed plan to fix the problem.
              - Write your plan and information from your research to a markdown file. Continually refer to this as you work.
              - Use the sequential-thinking tool to plan your actions.
              - Implement the fix and test it thoroughly.
              - If the fix might affect core functionality, update or add tests focused on that functionality.
              - Run all pre-commit lint checks and ensure everything is formatted correctly ('hk check', 'hk fix').
              - Use conventional commits format.
              - Copy your planning file into your PR and then delete it before submitting.
              - Submit your changes in a pull request:
                - Document your changes and the reasoning behind them.
                - Provide your markdown file with the plan and research information.
              - Submit your solution for review.
